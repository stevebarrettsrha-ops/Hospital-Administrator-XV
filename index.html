<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Hospital Administrator Dashboard ‚Äî Standalone</title>

  <!-- Tailwind (Play CDN) -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- React + ReactDOM (UMD) -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>

  <!-- Babel for in-browser JSX transpile -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

  <style>
    /* Chief Orderly Dashboard Inspired Styles */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      background: linear-gradient(135deg, #6ee7b7 0%, #7dd3fc 100%);
      min-height: 100vh;
    }

    /* Animations */
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    @keyframes slideUp {
      from { opacity: 0; transform: translateY(30px); }
      to { opacity: 1; transform: translateY(0); }
    }

    @keyframes slideDown {
      from { opacity: 0; transform: translateY(-10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .animate-fadeIn { animation: fadeIn 0.4s ease; }
    .animate-slideUp { animation: slideUp 0.5s ease; }
    .animate-slideDown { animation: slideDown 0.3s ease; }

    /* Navigation Header */
    .nav-header {
      background: white;
      border-radius: 12px;
      padding: 20px 30px;
      margin-bottom: 30px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }

    .nav-tabs {
      display: flex;
      gap: 10px;
      background: #f7fafc;
      padding: 6px;
      border-radius: 10px;
      flex-wrap: wrap;
    }

    .nav-tab {
      padding: 12px 24px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 15px;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 8px;
      transition: all 0.3s;
      background: transparent;
      color: #718096;
    }

    .nav-tab:hover {
      color: #1a202c;
      background: #e2e8f0;
    }

    .nav-tab.active {
      background: linear-gradient(135deg, #10b981 0%, #0ea5e9 100%);
      color: white;
      box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
    }

    /* Main Icon */
    .main-icon {
      width: 50px;
      height: 50px;
      background: linear-gradient(135deg, #10b981 0%, #0ea5e9 100%);
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 24px;
      font-weight: bold;
    }

    /* Buttons */
    .btn-primary {
      background: linear-gradient(135deg, #10b981 0%, #059669 100%);
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(16, 185, 129, 0.4);
    }

    .btn-secondary {
      background: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%);
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
    }

    .btn-secondary:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(99, 102, 241, 0.4);
    }

    /* Cards */
    .dashboard-card {
      background: white;
      border-radius: 12px;
      padding: 24px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      transition: all 0.3s;
    }

    .dashboard-card:hover {
      box-shadow: 0 8px 16px rgba(0, 0, 0, 0.15);
      transform: translateY(-2px);
    }

    /* Stats */
    .stat-card {
      background: white;
      border-radius: 12px;
      padding: 24px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      transition: all 0.3s;
      border-left: 4px solid;
    }

    .stat-card:hover {
      transform: translateY(-3px);
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.12);
    }

    .stat-card.blue { border-left-color: #0ea5e9; }
    .stat-card.green { border-left-color: #10b981; }
    .stat-card.purple { border-left-color: #a855f7; }
    .stat-card.red { border-left-color: #ef4444; }

    /* Form Inputs */
    .form-input {
      width: 100%;
      padding: 12px 15px;
      border: 2px solid #e2e8f0;
      border-radius: 8px;
      font-size: 14px;
      transition: all 0.3s ease;
    }

    .form-input:focus {
      outline: none;
      border-color: #10b981;
      box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1);
    }

    .form-input.error {
      border-color: #ef4444;
      box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.1);
    }

    /* User Info Badge */
    .user-info {
      display: flex;
      align-items: center;
      gap: 10px;
      background: rgba(16, 185, 129, 0.1);
      padding: 10px 20px;
      border-radius: 25px;
    }

    /* Table Styling */
    .data-table {
      width: 100%;
      border-collapse: collapse;
    }

    .data-table th {
      background: linear-gradient(135deg, #f7fafc 0%, #edf2f7 100%);
      padding: 12px 16px;
      text-align: left;
      font-size: 13px;
      font-weight: 600;
      color: #4a5568;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .data-table td {
      padding: 12px 16px;
      border-bottom: 1px solid #e2e8f0;
    }

    .data-table tr:hover {
      background: #f7fafc;
    }

    .data-table tr.total-row {
      background: linear-gradient(135deg, #ecfdf5 0%, #d1fae5 100%);
      font-weight: 600;
    }

    /* Priority Badges */
    .priority-badge {
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
      text-transform: uppercase;
    }

    .priority-badge.high {
      background: #fee2e2;
      color: #ef4444;
    }

    .priority-badge.medium {
      background: #fef3c7;
      color: #f59e0b;
    }

    .priority-badge.low {
      background: #d1fae5;
      color: #10b981;
    }

    /* Toast Notification */
    .toast {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 1000;
      padding: 16px 24px;
      border-radius: 12px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
      display: flex;
      align-items: center;
      gap: 12px;
      animation: slideDown 0.3s ease;
    }

    .toast.success { background: linear-gradient(135deg, #10b981, #059669); color: white; }
    .toast.error { background: linear-gradient(135deg, #ef4444, #dc2626); color: white; }
    .toast.warning { background: linear-gradient(135deg, #f59e0b, #d97706); color: white; }
    .toast.info { background: linear-gradient(135deg, #0ea5e9, #0284c7); color: white; }

    /* Modal */
    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      padding: 20px;
    }

    .modal-content {
      background: white;
      border-radius: 12px;
      max-width: 700px;
      width: 100%;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
      animation: slideUp 0.3s ease;
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 20px 24px;
      border-bottom: 2px solid #e2e8f0;
    }

    .modal-body {
      padding: 24px;
    }

    .modal-footer {
      display: flex;
      justify-content: flex-end;
      gap: 12px;
      padding: 16px 24px;
      border-top: 2px solid #e2e8f0;
    }

    /* Chart container */
    .chart-container { width: 100%; height: 260px; }

    /* Icon buttons */
    .icon-btn {
      background: #f7fafc;
      border: none;
      width: 36px;
      height: 36px;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.3s;
      font-size: 16px;
    }

    .icon-btn:hover {
      background: #e2e8f0;
      transform: scale(1.1);
    }

    .icon-btn.edit:hover { background: #dbeafe; color: #0ea5e9; }
    .icon-btn.delete:hover { background: #fee2e2; color: #ef4444; }

    /* Department Card */
    .dept-card {
      background: white;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      transition: all 0.3s;
      border-left: 4px solid;
    }

    .dept-card:hover {
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
      transform: translateX(5px);
    }

    .dept-card.high { border-left-color: #ef4444; }
    .dept-card.medium { border-left-color: #f59e0b; }
    .dept-card.low { border-left-color: #10b981; }

    /* Dark mode overrides */
    .dark .nav-header,
    .dark .dashboard-card,
    .dark .stat-card,
    .dark .dept-card,
    .dark .modal-content {
      background: #1f2937;
      color: #f3f4f6;
    }

    .dark .nav-tabs {
      background: #374151;
    }

    .dark .nav-tab {
      color: #9ca3af;
    }

    .dark .nav-tab:hover {
      background: #4b5563;
      color: #f3f4f6;
    }

    .dark .form-input {
      background: #374151;
      border-color: #4b5563;
      color: #f3f4f6;
    }

    .dark .data-table th {
      background: #374151;
      color: #d1d5db;
    }

    .dark .data-table td {
      border-bottom-color: #374151;
    }

    .dark .data-table tr:hover {
      background: #374151;
    }

    /* Scrollbar styling */
    ::-webkit-scrollbar {
      width: 8px;
      height: 8px;
    }

    ::-webkit-scrollbar-track {
      background: #f1f1f1;
      border-radius: 4px;
    }

    ::-webkit-scrollbar-thumb {
      background: linear-gradient(135deg, #10b981, #0ea5e9);
      border-radius: 4px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: linear-gradient(135deg, #059669, #0284c7);
    }
  </style>
</head>
<body class="min-h-screen">

  <div id="root"></div>

  <script type="text/babel">
  const { useState, useEffect, useRef } = React;

  /***** Configuration *****/
  const SHEET_URL = 'https://docs.google.com/spreadsheets/d/1HTmxT2hM1XXChwPjIT2aGl93nnmcpvaMxLddzm4OouY/export?format=csv';
  const LS_KEY = 'hospital_dashboard_v1'; // localStorage key

  /***** Helper: CSV export *****/
  function downloadCSV(filename, content) {
    const blob = new Blob([content], { type: 'text/csv' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  }

  /***** Default dataset (fallback if sheet fails) *****/
  const DEFAULT_DEPARTMENTS = [
    { name: "General Storage (Food/Sundries/Sanitation)", issues: "Decentralization of storage and limited storage space impacting efficiency. Breezeway leaks and floods storage area when it rains. Donation received from National Healthcare Enhancement Fund.", barriers: "Insufficient storage space, Chill Room Out of Commission", recommendations: "Overhead expansion. Repair or replace to maximize efficiency.", priority: "High" },
    { name: "Medical Sundries Storage", issues: "Medical Sundries room flooded each time tanks overflow or during heavy rain. Eyewash station needed for Chemical Room staff.", barriers: "Delay in paying suppliers", recommendations: "Relocate water tanks. Assess structure and correct defect to prevent flooding. Down payment made for eyewash station.", priority: "High" },
    { name: "Laundry Equipment/Seamstress", issues: "New Industrial Washer still out of commission. Heat nuisance in Folding Room due to malfunctioning AC.", barriers: "Delay in procuring part (circuit board) for AC Unit", recommendations: "Replace Unit or change out parts to maximize efficiency", priority: "Medium" },
    { name: "Target Pest Management", issues: "Contractor conducting pest treatment as scheduled. Final date in October 2025.", barriers: "None", recommendations: "Continue monitoring", priority: "Low" },
    { name: "Cleaning and Portering (MEL)", issues: "Deep cleaning not done as per schedule.", barriers: "Weakness in Supervision", recommendations: "Improve supervision protocols", priority: "Medium" },
    { name: "Security (Modern Investigations)", issues: "Inconsistency in supervision", barriers: "Communication", recommendations: "Improve service delivery through ongoing training and development of Security Officers", priority: "Medium" },
    { name: "Sanitation (Rentokil Limited)", issues: "Company is responsive and issues resolved in timely manner.", barriers: "None", recommendations: "Continue current service", priority: "Low" },
    { name: "Waste Disposal (SPM Waste Management)", issues: "Occasional delay in garbage pickup", barriers: "None", recommendations: "Contact SPM when there is a challenge", priority: "Low" }
  ];

  const DEFAULT_FLEET = [
    { ambulance: "304586", inter: 10, intra: 5, fuel: 96203.8, remarks: "" },
    { ambulance: "304992", inter: 19, intra: 16, fuel: 118114.59, remarks: "Awaiting new stretcher from Regional Fleet Manager" },
    { ambulance: "305126", inter: 8, intra: 8, fuel: 9720.5, remarks: "Loaned to Chapelton Hospital Sept 23-30, 2025" }
  ];

  const DEFAULT_PERSONNEL = [
    { title: "Driver Replacement", description: "Mr. Leaughn Williams joined the Transport Team on September 23, 2025 as ambulance driver. This was a well-needed replacement and drivers are now relieved." },
    { title: "Commendation", description: "Special commendation to the transport Team for their dedication and resilience throughout the challenging period." },
    { title: "Training - Mandatory Defensive Driving Workshop", description: "Mr. Griffiths, Mr. Williams and Mr. Douglas: October 1-2, 2025, 8:30am-5pm. Mr. Chambers, Mr. Lewis and Mr. Campbell: October 8-9, 2025." }
  ];

  /***** Utility: CSV parser (simple, handles quotes) *****/
  function parseCSV(text) {
    const lines = text.split(/\r?\n/);
    const rows = lines.map(line => {
      const result = [];
      let cur = '';
      let inQuotes = false;
      for (let i = 0; i < line.length; i++) {
        const ch = line[i];
        if (ch === '"') {
          if (inQuotes && line[i+1] === '"') { cur += '"'; i++; } else { inQuotes = !inQuotes; }
        } else if (ch === ',' && !inQuotes) {
          result.push(cur);
          cur = '';
        } else {
          cur += ch;
        }
      }
      result.push(cur);
      return result;
    });
    return rows;
  }

  /***** Main App *****/
  function App(){
    // UI state
    const [activeTab, setActiveTab] = useState('overview');
    const [searchTerm, setSearchTerm] = useState('');
    const [darkMode, setDarkMode] = useState(false);
    const [notifications, setNotifications] = useState(3);
    const [username] = useState('Administrator');
    const [loading, setLoading] = useState(false);
    const [lastSync, setLastSync] = useState(null);

    // Data states
    const [departments, setDepartments] = useState([]);
    const [fleetData, setFleetData] = useState([]);
    const [personnelUpdates, setPersonnelUpdates] = useState([]);
    const [totalPatients, setTotalPatients] = useState(0);

    // Form states
    const [newDept, setNewDept] = useState({ name: '', issues: '', barriers: '', recommendations: '', priority: 'Medium' });
    const [newFleet, setNewFleet] = useState({ ambulance: '', inter: 0, intra: 0, fuel: 0, remarks: '' });
    const [newPersonnel, setNewPersonnel] = useState({ title: '', description: '' });

    // Edit modal states
    const [editModal, setEditModal] = useState({ open: false, type: null, index: null, data: null });

    // Toast notification state
    const [toast, setToast] = useState({ show: false, message: '', type: 'success' });

    // Form validation errors
    const [errors, setErrors] = useState({ dept: {}, fleet: {}, personnel: {} });

    // Undo stack for deletions
    const [undoStack, setUndoStack] = useState([]);

    // Charts refs
    const priorityChartRef = useRef(null);
    const tripsChartRef = useRef(null);
    const fleetCompareRef = useRef(null);

    // Load from localStorage if available
    useEffect(() => {
      try {
        const raw = localStorage.getItem(LS_KEY);
        if (raw) {
          const parsed = JSON.parse(raw);
          if (parsed.departments) setDepartments(parsed.departments);
          if (parsed.fleetData) setFleetData(parsed.fleetData);
          if (parsed.personnelUpdates) setPersonnelUpdates(parsed.personnelUpdates);
          if (typeof parsed.totalPatients === 'number') setTotalPatients(parsed.totalPatients);
          if (typeof parsed.darkMode === 'boolean') setDarkMode(parsed.darkMode);
          if (typeof parsed.notifications === 'number') setNotifications(parsed.notifications);
        } else {
          // initialize with defaults until sheet load
          setDepartments(DEFAULT_DEPARTMENTS);
          setFleetData(DEFAULT_FLEET);
          setPersonnelUpdates(DEFAULT_PERSONNEL);
          setTotalPatients(116);
        }
      } catch (e) {
        console.warn('Failed to load from localStorage', e);
      }
    }, []);

    // Auto-save to localStorage whenever the core data changes
    useEffect(() => {
      const payload = {
        departments,
        fleetData,
        personnelUpdates,
        totalPatients,
        darkMode,
        notifications
      };
      try {
        localStorage.setItem(LS_KEY, JSON.stringify(payload));
      } catch (e) {
        console.warn('Autosave failed', e);
      }
    }, [departments, fleetData, personnelUpdates, totalPatients, darkMode, notifications]);

    // Google Sheet loader (tries to fetch CSV, then merges with local data if present)
    const loadFromGoogleSheet = async () => {
      setLoading(true);
      try {
        const res = await fetch(SHEET_URL);
        if (!res.ok) throw new Error('Network response not ok');
        const csv = await res.text();
        const rows = parseCSV(csv);

        // We'll extract roughly the same rows as original TSX expected
        const depts = [];
        // rows indexing may vary; attempt safe extraction with fallback
        // We'll attempt to find rows that look like department rows by content length
        // but to keep faithful, use previously-known indices (1,3,5,7,9,11,12,13) if present
        const idxs = [1,3,5,7,9,11,12,13];
        idxs.forEach(i => {
          if (rows[i]) {
            // try to map columns to fields
            const row = rows[i];
            const name = row[0] || '';
            const issues = row[1] || '';
            const barriers = row[2] || '';
            const recommendations = row[3] || '';
            // Choose priority based on presence of certain words (fallback to Medium)
            let priority = 'Medium';
            if (/flood|out of commission|delay|insufficient|urgent|critical/i.test(issues + barriers + recommendations)) priority = 'High';
            if (/none|continue/i.test(barriers + recommendations)) priority = 'Low';
            depts.push({ name: name || DEFAULT_DEPARTMENTS[0].name, issues, barriers, recommendations, priority });
          }
        });

        // If no depts parsed, fallback to defaults
        const finalDepts = depts.length ? depts : DEFAULT_DEPARTMENTS;

        // fleet rows indices 17-19
        const fleet = [];
        for (let i = 17; i <= 19; i++) {
          if (rows[i] && rows[i][0]) {
            const ambulance = rows[i][0] || '';
            const inter = parseInt(rows[i][1]) || 0;
            const intra = parseInt(rows[i][2]) || 0;
            const fuel = parseFloat((rows[i][3] || '0').replace(/[^0-9.-]+/g,'')) || 0;
            const remarks = rows[i][4] || '';
            fleet.push({ ambulance, inter, intra, fuel, remarks });
          }
        }
        const finalFleet = fleet.length ? fleet : DEFAULT_FLEET;

        // total patients row 23 (index 23)
        let sheetTotalPatients = null;
        if (rows[23] && rows[23][0]) {
          sheetTotalPatients = parseInt(rows[23][0]) || null;
        }

        // personnel (rows 25-33 area)
        const personnel = [];
        if (rows[25] && rows[25][0]) {
          personnel.push({ title: 'Driver Replacement', description: (rows[25][0] + ' ' + (rows[26] ? rows[26][0] : '')).trim() });
        }
        if (rows[28] && rows[28][0]) {
          personnel.push({ title: 'Commendation', description: rows[28][0] });
        }
        if (rows[30] && rows[30][0]) {
          const trainingDesc = [rows[30][0], rows[31]?.[0], rows[32]?.[0]].filter(Boolean).join(' ');
          personnel.push({ title: 'Training - Mandatory Defensive Driving Workshop', description: trainingDesc });
        }
        const finalPersonnel = personnel.length ? personnel : DEFAULT_PERSONNEL;

        // Merge strategy: prefer local values if present (so local edits persist)
        const rawLocal = localStorage.getItem(LS_KEY);
        if (rawLocal) {
          try {
            const parsed = JSON.parse(rawLocal);
            // If local has arrays with length > 0, use them; otherwise use sheet
            setDepartments((parsed.departments && parsed.departments.length) ? parsed.departments : finalDepts);
            setFleetData((parsed.fleetData && parsed.fleetData.length) ? parsed.fleetData : finalFleet);
            setPersonnelUpdates((parsed.personnelUpdates && parsed.personnelUpdates.length) ? parsed.personnelUpdates : finalPersonnel);
            setTotalPatients((typeof parsed.totalPatients === 'number' && parsed.totalPatients >= 0) ? parsed.totalPatients : (sheetTotalPatients ?? 116));
          } catch (e) {
            // parse failure -> use sheet results
            setDepartments(finalDepts);
            setFleetData(finalFleet);
            setPersonnelUpdates(finalPersonnel);
            setTotalPatients(sheetTotalPatients ?? 116);
          }
        } else {
          // No local -> use sheet results
          setDepartments(finalDepts);
          setFleetData(finalFleet);
          setPersonnelUpdates(finalPersonnel);
          setTotalPatients(sheetTotalPatients ?? 116);
        }

        setLastSync(new Date());
        showToast('Data synchronized with Google Sheet successfully', 'success');
      } catch (err) {
        console.warn('Sheet load failed, using local/defaults', err);
        showToast('Could not load data from Google Sheet - using local data', 'warning');
      } finally {
        setLoading(false);
      }
    };

    // initial attempt to fetch sheet once after mount (but we already loaded local)
    useEffect(() => {
      loadFromGoogleSheet();
    }, []);

    /***** Derived metrics *****/
    const totalTrips = fleetData.reduce((s,i) => s + (parseInt(i.inter)||0) + (parseInt(i.intra)||0), 0);
    const totalFuel = fleetData.reduce((s,i) => s + (parseFloat(i.fuel)||0), 0);

    /***** Charts setup & updates (Chart.js) *****/
    // Priority pie
    useEffect(() => {
      const counts = {
        High: departments.filter(d => d.priority === 'High').length,
        Medium: departments.filter(d => d.priority === 'Medium').length,
        Low: departments.filter(d => d.priority === 'Low').length
      };
      const ctx = priorityChartRef.current;
      if (!ctx) return;
      if (ctx._chartInstance) { ctx._chartInstance.destroy(); ctx._chartInstance = null; }
      ctx._chartInstance = new Chart(ctx, {
        type: 'pie',
        data: {
          labels: ['High Priority','Medium Priority','Low Priority'],
          datasets: [{ data: [counts.High, counts.Medium, counts.Low], backgroundColor: ['#ef4444','#f59e0b','#10b981'] }]
        },
        options: { responsive: true, plugins: { legend: { position: 'bottom' } } }
      });
    }, [departments]);

    // Trips bar (small)
    useEffect(() => {
      const ctx = tripsChartRef.current;
      if (!ctx) return;
      if (ctx._chartInstance) { ctx._chartInstance.destroy(); ctx._chartInstance = null; }
      ctx._chartInstance = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: fleetData.map(f => f.ambulance),
          datasets: [
            { label: 'Inter-facility', data: fleetData.map(f => f.inter), backgroundColor: '#3b82f6' },
            { label: 'Intra-facility', data: fleetData.map(f => f.intra), backgroundColor: '#8b5cf6' }
          ]
        },
        options: { responsive: true, plugins: { legend: { position: 'bottom' } }, scales: { y: { beginAtZero: true } } }
      });
    }, [fleetData]);

    // Fleet compare (large)
    useEffect(() => {
      const ctx = fleetCompareRef.current;
      if (!ctx) return;
      if (ctx._chartInstance) { ctx._chartInstance.destroy(); ctx._chartInstance = null; }
      ctx._chartInstance = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: fleetData.map(f => f.ambulance),
          datasets: [
            { label: 'Inter-facility', data: fleetData.map(f => f.inter), backgroundColor: '#3b82f6' },
            { label: 'Intra-facility', data: fleetData.map(f => f.intra), backgroundColor: '#8b5cf6' }
          ]
        },
        options: { responsive: true, plugins: { legend: { position: 'bottom' } }, scales: { y: { beginAtZero: true } } }
      });
    }, [fleetData]);

    /***** Toast notification helper *****/
    const showToast = (message, type = 'success') => {
      setToast({ show: true, message, type });
      setTimeout(() => setToast({ show: false, message: '', type: 'success' }), 3000);
    };

    /***** Validation helpers *****/
    const validateDepartment = (dept, excludeIndex = -1) => {
      const errs = {};
      if (!dept.name || dept.name.trim() === '') errs.name = 'Department name is required';
      if (!dept.issues || dept.issues.trim() === '') errs.issues = 'Current issues is required';
      // Check for duplicates
      const duplicate = departments.find((d, i) => i !== excludeIndex && d.name.toLowerCase() === dept.name.toLowerCase());
      if (duplicate) errs.name = 'A department with this name already exists';
      return errs;
    };

    const validateFleet = (fleet, excludeIndex = -1) => {
      const errs = {};
      if (!fleet.ambulance || fleet.ambulance.trim() === '') errs.ambulance = 'Ambulance license is required';
      if (fleet.inter < 0) errs.inter = 'Inter-facility trips cannot be negative';
      if (fleet.intra < 0) errs.intra = 'Intra-facility trips cannot be negative';
      if (fleet.fuel < 0) errs.fuel = 'Fuel cost cannot be negative';
      // Check for duplicates
      const duplicate = fleetData.find((f, i) => i !== excludeIndex && f.ambulance === fleet.ambulance);
      if (duplicate) errs.ambulance = 'This ambulance license already exists';
      return errs;
    };

    const validatePersonnel = (personnel) => {
      const errs = {};
      if (!personnel.title || personnel.title.trim() === '') errs.title = 'Title is required';
      if (!personnel.description || personnel.description.trim() === '') errs.description = 'Description is required';
      return errs;
    };

    /***** Form reset helpers *****/
    const resetDeptForm = () => {
      setNewDept({ name: '', issues: '', barriers: '', recommendations: '', priority: 'Medium' });
      setErrors(prev => ({ ...prev, dept: {} }));
    };

    const resetFleetForm = () => {
      setNewFleet({ ambulance: '', inter: 0, intra: 0, fuel: 0, remarks: '' });
      setErrors(prev => ({ ...prev, fleet: {} }));
    };

    const resetPersonnelForm = () => {
      setNewPersonnel({ title: '', description: '' });
      setErrors(prev => ({ ...prev, personnel: {} }));
    };

    /***** Edit modal helpers *****/
    const openEditModal = (type, index, data) => {
      setEditModal({ open: true, type, index, data: { ...data } });
    };

    const closeEditModal = () => {
      setEditModal({ open: false, type: null, index: null, data: null });
    };

    const saveEdit = () => {
      const { type, index, data } = editModal;

      if (type === 'department') {
        const errs = validateDepartment(data, index);
        if (Object.keys(errs).length > 0) {
          showToast('Please fix validation errors', 'error');
          return;
        }
        setDepartments(prev => prev.map((d, i) => i === index ? { ...data } : d));
        showToast('Department updated successfully', 'success');
      } else if (type === 'fleet') {
        const errs = validateFleet(data, index);
        if (Object.keys(errs).length > 0) {
          showToast('Please fix validation errors', 'error');
          return;
        }
        setFleetData(prev => prev.map((f, i) => i === index ? {
          ...data,
          inter: parseInt(data.inter) || 0,
          intra: parseInt(data.intra) || 0,
          fuel: parseFloat(data.fuel) || 0
        } : f));
        showToast('Fleet vehicle updated successfully', 'success');
      } else if (type === 'personnel') {
        const errs = validatePersonnel(data);
        if (Object.keys(errs).length > 0) {
          showToast('Please fix validation errors', 'error');
          return;
        }
        setPersonnelUpdates(prev => prev.map((p, i) => i === index ? { ...data } : p));
        showToast('Personnel update saved successfully', 'success');
      }

      closeEditModal();
    };

    const updateEditData = (field, value) => {
      setEditModal(prev => ({
        ...prev,
        data: { ...prev.data, [field]: value }
      }));
    };

    /***** Undo functionality *****/
    const undoDelete = () => {
      if (undoStack.length === 0) return;
      const lastAction = undoStack[undoStack.length - 1];

      if (lastAction.type === 'department') {
        setDepartments(prev => {
          const newArr = [...prev];
          newArr.splice(lastAction.index, 0, lastAction.data);
          return newArr;
        });
      } else if (lastAction.type === 'fleet') {
        setFleetData(prev => {
          const newArr = [...prev];
          newArr.splice(lastAction.index, 0, lastAction.data);
          return newArr;
        });
      } else if (lastAction.type === 'personnel') {
        setPersonnelUpdates(prev => {
          const newArr = [...prev];
          newArr.splice(lastAction.index, 0, lastAction.data);
          return newArr;
        });
      }

      setUndoStack(prev => prev.slice(0, -1));
      showToast('Deletion undone', 'info');
    };

    /***** CRUD operations (auto-saved because of effect hooking into state) *****/
    const addDepartment = () => {
      const errs = validateDepartment(newDept);
      setErrors(prev => ({ ...prev, dept: errs }));
      if (Object.keys(errs).length > 0) {
        showToast('Please fix validation errors', 'error');
        return;
      }
      setDepartments(prev => [...prev, {...newDept}]);
      resetDeptForm();
      showToast('Department added successfully', 'success');
      setActiveTab('departments');
    };

    const removeDepartment = (idx) => {
      if (!confirm('Remove this department?')) return;
      const deleted = departments[idx];
      setUndoStack(prev => [...prev, { type: 'department', index: idx, data: deleted }]);
      setDepartments(prev => prev.filter((_,i)=>i!==idx));
      showToast('Department removed. Click Undo to restore.', 'warning');
    };

    const addFleet = () => {
      const errs = validateFleet(newFleet);
      setErrors(prev => ({ ...prev, fleet: errs }));
      if (Object.keys(errs).length > 0) {
        showToast('Please fix validation errors', 'error');
        return;
      }
      setFleetData(prev => [...prev, {...newFleet, inter: parseInt(newFleet.inter)||0, intra: parseInt(newFleet.intra)||0, fuel: parseFloat(newFleet.fuel)||0 }]);
      resetFleetForm();
      showToast('Fleet vehicle added successfully', 'success');
      setActiveTab('fleet');
    };

    const removeFleet = (idx) => {
      if (!confirm('Remove this vehicle?')) return;
      const deleted = fleetData[idx];
      setUndoStack(prev => [...prev, { type: 'fleet', index: idx, data: deleted }]);
      setFleetData(prev => prev.filter((_,i)=>i!==idx));
      showToast('Fleet vehicle removed. Click Undo to restore.', 'warning');
    };

    const addPersonnel = () => {
      const errs = validatePersonnel(newPersonnel);
      setErrors(prev => ({ ...prev, personnel: errs }));
      if (Object.keys(errs).length > 0) {
        showToast('Please fix validation errors', 'error');
        return;
      }
      setPersonnelUpdates(prev => [...prev, {...newPersonnel}]);
      resetPersonnelForm();
      showToast('Personnel update added successfully', 'success');
      setActiveTab('personnel');
    };

    const removePersonnel = (idx) => {
      if (!confirm('Remove this personnel update?')) return;
      const deleted = personnelUpdates[idx];
      setUndoStack(prev => [...prev, { type: 'personnel', index: idx, data: deleted }]);
      setPersonnelUpdates(prev => prev.filter((_,i)=>i!==idx));
      showToast('Personnel update removed. Click Undo to restore.', 'warning');
    };

    const exportToCSV = () => {
      let csv = 'DEPARTMENT,ISSUES,BARRIERS,RECOMMENDATIONS,PRIORITY\n';
      departments.forEach(d => {
        csv += `"${(d.name||'').replace(/"/g,'""')}","${(d.issues||'').replace(/"/g,'""')}","${(d.barriers||'').replace(/"/g,'""')}","${(d.recommendations||'').replace(/"/g,'""')}","${d.priority}"\n`;
      });
      csv += '\nFLEET\nAMBULANCE,INTER,INTRA,FUEL,REMARKS\n';
      fleetData.forEach(f => {
        csv += `"${(f.ambulance||'').replace(/"/g,'""')}",${f.inter||0},${f.intra||0},${f.fuel||0},"${(f.remarks||'').replace(/"/g,'""')}"\n`;
      });
      csv += `\nTOTAL_PATIENTS,${totalPatients}\n\nPERSONNEL\nTITLE,DESCRIPTION\n`;
      personnelUpdates.forEach(p => {
        csv += `"${(p.title||'').replace(/"/g,'""')}","${(p.description||'').replace(/"/g,'""')}"\n`;
      });
      downloadCSV('hospital_report.csv', csv);
      showToast('Data exported to hospital_report.csv', 'success');
    };

    const handleLogout = () => {
      alert('Logging out...');
    };

    /***** UI render *****/
    return (
      <div className={`min-h-screen ${darkMode ? 'dark bg-gray-900 text-white' : ''}`}>
        {/* Navigation Header - Chief Orderly Style */}
        <div className="container mx-auto px-4 py-5">
          <div className={`nav-header ${darkMode ? 'bg-gray-800' : ''}`}>
            {/* Top Row */}
            <div className="flex justify-between items-center mb-5 flex-wrap gap-4">
              {/* Logo & Title */}
              <div className="flex items-center gap-4">
                <div className="main-icon">HA</div>
                <div>
                  <h1 className="text-2xl font-bold text-gray-800" style={{color: darkMode ? '#f3f4f6' : '#1a202c'}}>Hospital Administrator</h1>
                  <p className="text-sm text-gray-500">Dashboard Management System</p>
                </div>
              </div>

              {/* User Info & Actions */}
              <div className="flex items-center gap-3 flex-wrap">
                {lastSync && <div className="text-xs text-gray-500 hidden md:block">Last sync: {lastSync.toLocaleString()}</div>}
                <button onClick={loadFromGoogleSheet} className="btn-secondary px-4 py-2 text-sm flex items-center gap-2">
                  {loading ? 'Syncing...' : '‚Üª Sync'}
                </button>
                <button onClick={exportToCSV} className="btn-primary px-4 py-2 text-sm flex items-center gap-2">
                  ‚Üì Export
                </button>
                <button onClick={() => setDarkMode(!darkMode)} className={`px-3 py-2 rounded-lg font-semibold text-sm transition-all ${darkMode ? 'bg-yellow-500 text-gray-900' : 'bg-gray-700 text-white'}`}>
                  {darkMode ? '‚òÄ Light' : '‚òæ Dark'}
                </button>
                <div className="relative">
                  <button className="w-10 h-10 bg-white rounded-full shadow flex items-center justify-center text-xl hover:scale-110 transition-transform">
                    üîî
                  </button>
                  {notifications > 0 && <span className="absolute -top-1 -right-1 bg-red-500 text-white text-xs rounded-full w-5 h-5 flex items-center justify-center font-bold">{notifications}</span>}
                </div>
                <div className="user-info">
                  <div className="w-8 h-8 rounded-full bg-gradient-to-br from-emerald-400 to-cyan-500 flex items-center justify-center text-white font-bold text-sm">
                    {username.charAt(0)}
                  </div>
                  <span className="text-sm font-semibold text-gray-700" style={{color: darkMode ? '#f3f4f6' : '#1a202c'}}>{username}</span>
                  <button onClick={handleLogout} className="px-3 py-1 bg-red-500 text-white rounded-full text-xs font-semibold hover:bg-red-600 transition-colors">
                    Logout
                  </button>
                </div>
              </div>
            </div>

            {/* Navigation Tabs */}
            <div className={`nav-tabs ${darkMode ? 'bg-gray-700' : ''}`}>
              {[
                { id: 'overview', label: 'üìä Overview', icon: 'üìä' },
                { id: 'departments', label: 'üè¢ Departments', icon: 'üè¢' },
                { id: 'fleet', label: 'üöë Fleet Report', icon: 'üöë' },
                { id: 'personnel', label: 'üë• Personnel', icon: 'üë•' },
                { id: 'data-entry', label: 'üìù Data Entry', icon: 'üìù' }
              ].map(tab => (
                <button key={tab.id} onClick={() => setActiveTab(tab.id)}
                  className={`nav-tab ${activeTab===tab.id ? 'active' : ''}`}>
                  {tab.label}
                </button>
              ))}
            </div>
          </div>
        </div>

        {/* Main content */}
        <main className="container mx-auto px-4 py-8 space-y-6">
          {/* Loading overlay */}
          {loading && (
            <div className="fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center z-50">
              <div className="bg-white p-6 rounded shadow">Loading data...</div>
            </div>
          )}

          {/* Toast notification */}
          {toast.show && (
            <div className={`toast ${toast.type}`}>
              <span className="text-lg">{toast.type === 'success' ? '‚úì' : toast.type === 'error' ? '‚úï' : toast.type === 'warning' ? '‚ö†' : '‚Ñπ'}</span>
              <span className="font-medium">{toast.message}</span>
              {undoStack.length > 0 && toast.type === 'warning' && (
                <button onClick={undoDelete} className="ml-2 px-3 py-1 bg-white text-gray-800 rounded-lg text-sm font-semibold hover:bg-gray-100 transition-colors">
                  Undo
                </button>
              )}
              <button onClick={() => setToast({ show: false, message: '', type: 'success' })} className="ml-2 text-xl font-bold hover:opacity-70">&times;</button>
            </div>
          )}

          {/* Edit Modal */}
          {editModal.open && (
            <div className="modal-overlay">
              <div className={`modal-content ${darkMode ? 'bg-gray-800' : ''}`}>
                <div className="modal-header">
                  <h2 className="text-xl font-bold" style={{color: darkMode ? '#f3f4f6' : '#1a202c'}}>
                    ‚úèÔ∏è Edit {editModal.type === 'department' ? 'Department' : editModal.type === 'fleet' ? 'Fleet Vehicle' : 'Personnel Update'}
                  </h2>
                  <button onClick={closeEditModal} className="icon-btn delete text-2xl">&times;</button>
                </div>

                <div className="p-6 space-y-4">
                  {editModal.type === 'department' && editModal.data && (
                    <>
                      <div>
                        <label className="block text-sm font-medium mb-1">Department Name *</label>
                        <input type="text" value={editModal.data.name || ''} onChange={(e) => updateEditData('name', e.target.value)}
                          className={`w-full px-4 py-2 border rounded ${darkMode ? 'bg-gray-700 border-gray-600' : 'border-gray-300'}`} />
                      </div>
                      <div>
                        <label className="block text-sm font-medium mb-1">Current Issues *</label>
                        <textarea rows="3" value={editModal.data.issues || ''} onChange={(e) => updateEditData('issues', e.target.value)}
                          className={`w-full px-4 py-2 border rounded ${darkMode ? 'bg-gray-700 border-gray-600' : 'border-gray-300'}`}></textarea>
                      </div>
                      <div>
                        <label className="block text-sm font-medium mb-1">Barriers</label>
                        <textarea rows="2" value={editModal.data.barriers || ''} onChange={(e) => updateEditData('barriers', e.target.value)}
                          className={`w-full px-4 py-2 border rounded ${darkMode ? 'bg-gray-700 border-gray-600' : 'border-gray-300'}`}></textarea>
                      </div>
                      <div>
                        <label className="block text-sm font-medium mb-1">Recommendations</label>
                        <textarea rows="2" value={editModal.data.recommendations || ''} onChange={(e) => updateEditData('recommendations', e.target.value)}
                          className={`w-full px-4 py-2 border rounded ${darkMode ? 'bg-gray-700 border-gray-600' : 'border-gray-300'}`}></textarea>
                      </div>
                      <div>
                        <label className="block text-sm font-medium mb-1">Priority</label>
                        <select value={editModal.data.priority || 'Medium'} onChange={(e) => updateEditData('priority', e.target.value)}
                          className={`w-full px-4 py-2 border rounded ${darkMode ? 'bg-gray-700 border-gray-600' : 'border-gray-300'}`}>
                          <option value="Low">Low Priority</option>
                          <option value="Medium">Medium Priority</option>
                          <option value="High">High Priority</option>
                        </select>
                      </div>
                    </>
                  )}

                  {editModal.type === 'fleet' && editModal.data && (
                    <>
                      <div>
                        <label className="block text-sm font-medium mb-1">Ambulance License Number *</label>
                        <input type="text" value={editModal.data.ambulance || ''} onChange={(e) => updateEditData('ambulance', e.target.value)}
                          className={`w-full px-4 py-2 border rounded ${darkMode ? 'bg-gray-700 border-gray-600' : 'border-gray-300'}`} />
                      </div>
                      <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div>
                          <label className="block text-sm font-medium mb-1">Inter-facility Trips</label>
                          <input type="number" min="0" value={editModal.data.inter || 0} onChange={(e) => updateEditData('inter', parseInt(e.target.value) || 0)}
                            className={`w-full px-4 py-2 border rounded ${darkMode ? 'bg-gray-700 border-gray-600' : 'border-gray-300'}`} />
                        </div>
                        <div>
                          <label className="block text-sm font-medium mb-1">Intra-facility Trips</label>
                          <input type="number" min="0" value={editModal.data.intra || 0} onChange={(e) => updateEditData('intra', parseInt(e.target.value) || 0)}
                            className={`w-full px-4 py-2 border rounded ${darkMode ? 'bg-gray-700 border-gray-600' : 'border-gray-300'}`} />
                        </div>
                        <div>
                          <label className="block text-sm font-medium mb-1">Fuel Cost ($)</label>
                          <input type="number" min="0" step="0.01" value={editModal.data.fuel || 0} onChange={(e) => updateEditData('fuel', parseFloat(e.target.value) || 0)}
                            className={`w-full px-4 py-2 border rounded ${darkMode ? 'bg-gray-700 border-gray-600' : 'border-gray-300'}`} />
                        </div>
                      </div>
                      <div>
                        <label className="block text-sm font-medium mb-1">Remarks</label>
                        <textarea rows="2" value={editModal.data.remarks || ''} onChange={(e) => updateEditData('remarks', e.target.value)}
                          className={`w-full px-4 py-2 border rounded ${darkMode ? 'bg-gray-700 border-gray-600' : 'border-gray-300'}`}></textarea>
                      </div>
                    </>
                  )}

                  {editModal.type === 'personnel' && editModal.data && (
                    <>
                      <div>
                        <label className="block text-sm font-medium mb-1">Update Title *</label>
                        <input type="text" value={editModal.data.title || ''} onChange={(e) => updateEditData('title', e.target.value)}
                          className={`w-full px-4 py-2 border rounded ${darkMode ? 'bg-gray-700 border-gray-600' : 'border-gray-300'}`} />
                      </div>
                      <div>
                        <label className="block text-sm font-medium mb-1">Description *</label>
                        <textarea rows="4" value={editModal.data.description || ''} onChange={(e) => updateEditData('description', e.target.value)}
                          className={`w-full px-4 py-2 border rounded ${darkMode ? 'bg-gray-700 border-gray-600' : 'border-gray-300'}`}></textarea>
                      </div>
                    </>
                  )}
                </div>

                <div className={`p-4 border-t ${darkMode ? 'border-gray-700' : 'border-gray-200'} flex justify-end gap-3`}>
                  <button onClick={closeEditModal} className={`px-4 py-2 rounded ${darkMode ? 'bg-gray-700 hover:bg-gray-600' : 'bg-gray-200 hover:bg-gray-300'}`}>
                    Cancel
                  </button>
                  <button onClick={saveEdit} className="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600">
                    Save Changes
                  </button>
                </div>
              </div>
            </div>
          )}

          {/* Overview */}
          {activeTab === 'overview' && (
            <section className="space-y-6 animate-fadeIn">
              {/* Connection Status */}
              <div className={`dashboard-card ${darkMode ? 'bg-gray-800' : ''}`} style={{background: darkMode ? '' : 'linear-gradient(135deg, #ecfdf5 0%, #d1fae5 100%)'}}>
                <div className="flex items-center justify-between">
                  <div className="flex items-center gap-3">
                    <span className="text-2xl">{lastSync ? '‚úÖ' : '‚è≥'}</span>
                    <div>
                      <div className="font-semibold" style={{color: darkMode ? '#f3f4f6' : '#065f46'}}>{ lastSync ? 'Connected to Google Sheets' : 'Attempting to connect to Google Sheets' }</div>
                      <div className="text-sm text-gray-500">{ lastSync ? `Last updated: ${lastSync.toLocaleString()}` : 'Loading...' }</div>
                    </div>
                  </div>
                  <button onClick={loadFromGoogleSheet} className="btn-primary px-4 py-2 text-sm">‚Üª Refresh Data</button>
                </div>
              </div>

              {/* Key metrics */}
              <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                <div className={`stat-card blue ${darkMode ? 'bg-gray-800' : ''}`}>
                  <div className="flex items-center justify-between">
                    <div>
                      <p className="text-sm text-gray-500 mb-1">Total Departments</p>
                      <p className="text-3xl font-bold" style={{color: '#0ea5e9'}}>{departments.length}</p>
                    </div>
                    <span className="text-4xl opacity-20">üè¢</span>
                  </div>
                </div>
                <div className={`stat-card green ${darkMode ? 'bg-gray-800' : ''}`}>
                  <div className="flex items-center justify-between">
                    <div>
                      <p className="text-sm text-gray-500 mb-1">Total Ambulance Trips</p>
                      <p className="text-3xl font-bold" style={{color: '#10b981'}}>{totalTrips}</p>
                    </div>
                    <span className="text-4xl opacity-20">üöë</span>
                  </div>
                </div>
                <div className={`stat-card purple ${darkMode ? 'bg-gray-800' : ''}`}>
                  <div className="flex items-center justify-between">
                    <div>
                      <p className="text-sm text-gray-500 mb-1">Patients Transported</p>
                      <p className="text-3xl font-bold" style={{color: '#a855f7'}}>{totalPatients}</p>
                    </div>
                    <span className="text-4xl opacity-20">üë•</span>
                  </div>
                </div>
                <div className={`stat-card red ${darkMode ? 'bg-gray-800' : ''}`}>
                  <div className="flex items-center justify-between">
                    <div>
                      <p className="text-sm text-gray-500 mb-1">High Priority Issues</p>
                      <p className="text-3xl font-bold" style={{color: '#ef4444'}}>{departments.filter(d=>d.priority==='High').length}</p>
                    </div>
                    <span className="text-4xl opacity-20">‚ö†Ô∏è</span>
                  </div>
                </div>
              </div>

              {/* Charts */}
              <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div className={`dashboard-card ${darkMode ? 'bg-gray-800' : ''}`}>
                  <h3 className="font-bold mb-4 text-lg" style={{color: darkMode ? '#f3f4f6' : '#1a202c'}}>üìä Issues by Priority</h3>
                  <div className="chart-container">
                    <canvas ref={priorityChartRef}></canvas>
                  </div>
                </div>

                <div className={`dashboard-card ${darkMode ? 'bg-gray-800' : ''}`}>
                  <h3 className="font-bold mb-4 text-lg" style={{color: darkMode ? '#f3f4f6' : '#1a202c'}}>üìà Ambulance Trip Distribution</h3>
                  <div className="chart-container">
                    <canvas ref={tripsChartRef}></canvas>
                  </div>
                </div>
              </div>

              {/* Executive summary */}
              <div className={`dashboard-card ${darkMode ? 'bg-gray-800' : ''}`}>
                <h3 className="font-bold mb-4 text-lg" style={{color: darkMode ? '#f3f4f6' : '#1a202c'}}>üìã Executive Summary</h3>
                <div className="grid md:grid-cols-2 gap-6">
                  <div className="border-l-4 border-red-500 pl-4 py-3 rounded-r-lg" style={{background: 'rgba(239, 68, 68, 0.05)'}}>
                    <h4 className="font-bold text-red-600 mb-3 flex items-center gap-2">üö® Critical Issues</h4>
                    <ul className="text-sm space-y-2">
                      {departments.filter(d=>d.priority==='High').slice(0,3).map((d,i)=>(<li key={i} className="flex items-start gap-2"><span className="text-red-500">‚Ä¢</span> {d.name}</li>))}
                    </ul>
                  </div>
                  <div className="border-l-4 border-green-500 pl-4 py-3 rounded-r-lg" style={{background: 'rgba(16, 185, 129, 0.05)'}}>
                    <h4 className="font-bold text-green-600 mb-3 flex items-center gap-2">‚úÖ Positive Updates</h4>
                    <ul className="text-sm space-y-2">
                      <li className="flex items-start gap-2"><span className="text-green-500">‚Ä¢</span> {totalPatients} patients transported successfully</li>
                      <li className="flex items-start gap-2"><span className="text-green-500">‚Ä¢</span> {fleetData.length} ambulances in active service</li>
                      <li className="flex items-start gap-2"><span className="text-green-500">‚Ä¢</span> {departments.filter(d=>d.priority==='Low').length} departments performing well</li>
                    </ul>
                  </div>
                </div>
              </div>
            </section>
          )}

          {/* Departments */}
          {activeTab === 'departments' && (
            <section className="space-y-6">
              <div className={`${darkMode ? 'bg-gray-800' : 'bg-white'} p-4 rounded shadow`}>
                <div className="relative">
                  <input value={searchTerm} onChange={(e)=>setSearchTerm(e.target.value)} placeholder="Search departments, issues, or barriers..." className="w-full pl-4 pr-4 py-2 border rounded" />
                </div>
              </div>

              <div className="grid gap-6">
                {departments.filter(d => d.name.toLowerCase().includes(searchTerm.toLowerCase()) || d.issues.toLowerCase().includes(searchTerm.toLowerCase()))
                  .map((dept, idx) => (
                  <div key={idx} className={`${darkMode ? 'bg-gray-800' : 'bg-white'} rounded shadow overflow-hidden`}>
                    <div className={`p-4 ${dept.priority==='High' ? 'border-l-4 border-red-500 bg-red-50' : dept.priority==='Medium' ? 'border-l-4 border-yellow-500 bg-yellow-50' : 'border-l-4 border-green-500 bg-green-50'}`}>
                      <div className="flex justify-between">
                        <h3 className="font-semibold">{dept.name}</h3>
                        <span className="px-3 py-1 rounded-full text-xs font-semibold">
                          {dept.priority} Priority
                        </span>
                      </div>
                    </div>
                    <div className="p-6 space-y-3">
                      <div>
                        <h4 className="font-semibold">Current Issues</h4>
                        <p className="text-sm">{dept.issues}</p>
                      </div>
                      {dept.barriers && dept.barriers !== 'None' && (
                        <div>
                          <h4 className="font-semibold">Barriers</h4>
                          <p className="text-sm">{dept.barriers}</p>
                        </div>
                      )}
                      <div>
                        <h4 className="font-semibold">Recommendations</h4>
                        <p className="text-sm">{dept.recommendations}</p>
                      </div>
                      <div className="flex justify-end gap-2">
                        <button onClick={() => openEditModal('department', departments.indexOf(dept), dept)} className="px-3 py-2 text-blue-500 hover:bg-blue-50 rounded">Edit</button>
                        <button onClick={()=>removeDepartment(departments.indexOf(dept))} className="px-3 py-2 text-red-500 hover:bg-red-50 rounded">Remove</button>
                      </div>
                    </div>
                  </div>
                ))}
              </div>
            </section>
          )}

          {/* Fleet */}
          {activeTab === 'fleet' && (
            <section className="space-y-6">
              <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div className={`${darkMode ? 'bg-gray-800' : 'bg-white'} p-6 rounded shadow`}>
                  <h4 className="text-sm">Total Trips</h4>
                  <p className="text-3xl font-bold text-blue-600">{totalTrips}</p>
                  <p className="text-xs mt-1">Inter: {fleetData.reduce((s,i)=>s+(parseInt(i.inter)||0),0)} | Intra: {fleetData.reduce((s,i)=>s+(parseInt(i.intra)||0),0)}</p>
                </div>
                <div className={`${darkMode ? 'bg-gray-800' : 'bg-white'} p-6 rounded shadow`}>
                  <h4 className="text-sm">Patients Transported</h4>
                  <p className="text-3xl font-bold text-green-600">{totalPatients}</p>
                </div>
                <div className={`${darkMode ? 'bg-gray-800' : 'bg-white'} p-6 rounded shadow`}>
                  <h4 className="text-sm">Total Fuel Cost</h4>
                  <p className="text-3xl font-bold text-purple-600">${totalFuel.toLocaleString(undefined,{minimumFractionDigits:2, maximumFractionDigits:2})}</p>
                </div>
              </div>

              <div className={`${darkMode ? 'bg-gray-800' : 'bg-white'} rounded shadow overflow-hidden`}>
                <div className="p-6">
                  <h3 className="font-semibold mb-4">Ambulance Fleet Details</h3>
                  <div className="overflow-x-auto">
                    <table className="min-w-full">
                      <thead className={`${darkMode ? 'bg-gray-700' : 'bg-gray-50'}`}>
                        <tr>
                          <th className="px-4 py-2 text-left text-xs">License #</th>
                          <th className="px-4 py-2 text-left text-xs">Inter-facility</th>
                          <th className="px-4 py-2 text-left text-xs">Intra-facility</th>
                          <th className="px-4 py-2 text-left text-xs">Total Trips</th>
                          <th className="px-4 py-2 text-left text-xs">Fuel Cost</th>
                          <th className="px-4 py-2 text-left text-xs">Remarks</th>
                          <th className="px-4 py-2 text-left text-xs">Action</th>
                        </tr>
                      </thead>
                      <tbody>
                        {fleetData.map((v, i) => (
                          <tr key={i} className="hover:bg-gray-50">
                            <td className="px-4 py-2">{v.ambulance}</td>
                            <td className="px-4 py-2">{v.inter}</td>
                            <td className="px-4 py-2">{v.intra}</td>
                            <td className="px-4 py-2 font-semibold">{(parseInt(v.inter)||0)+(parseInt(v.intra)||0)}</td>
                            <td className="px-4 py-2">${(parseFloat(v.fuel)||0).toLocaleString(undefined,{minimumFractionDigits:2})}</td>
                            <td className="px-4 py-2">{v.remarks||'-'}</td>
                            <td className="px-4 py-2">
                              <button onClick={() => openEditModal('fleet', i, v)} className="text-blue-500 mr-2 hover:underline">Edit</button>
                              <button onClick={()=>removeFleet(i)} className="text-red-500 hover:underline">Remove</button>
                            </td>
                          </tr>
                        ))}
                        <tr className="font-semibold bg-blue-50">
                          <td className="px-4 py-2">TOTAL</td>
                          <td className="px-4 py-2">{fleetData.reduce((s,i)=>s+(parseInt(i.inter)||0),0)}</td>
                          <td className="px-4 py-2">{fleetData.reduce((s,i)=>s+(parseInt(i.intra)||0),0)}</td>
                          <td className="px-4 py-2">{totalTrips}</td>
                          <td className="px-4 py-2">${totalFuel.toLocaleString(undefined,{minimumFractionDigits:2})}</td>
                          <td className="px-4 py-2">-</td>
                          <td></td>
                        </tr>
                      </tbody>
                    </table>
                  </div>
                </div>
              </div>

              <div className={`${darkMode ? 'bg-gray-800' : 'bg-white'} p-6 rounded shadow`}>
                <h3 className="font-semibold mb-4">Trip Comparison by Ambulance</h3>
                <div className="chart-container">
                  <canvas ref={fleetCompareRef}></canvas>
                </div>
              </div>
            </section>
          )}

          {/* Personnel */}
          {activeTab === 'personnel' && (
            <section className="space-y-6">
              {personnelUpdates.map((u,i)=>(
                <div key={i} className={`${darkMode ? 'bg-gray-800' : 'bg-white'} p-6 rounded shadow`}>
                  <div className="flex items-start gap-4">
                    <div className={`${darkMode ? 'bg-blue-700' : 'bg-blue-100'} rounded-full p-3`}>U</div>
                    <div className="flex-1">
                      <h3 className="font-semibold">{u.title}</h3>
                      <p className="text-sm">{u.description}</p>
                    </div>
                    <div className="flex gap-2">
                      <button onClick={() => openEditModal('personnel', i, u)} className="text-blue-500 hover:underline">Edit</button>
                      <button onClick={()=>removePersonnel(i)} className="text-red-500 hover:underline">Remove</button>
                    </div>
                  </div>
                </div>
              ))}
            </section>
          )}

          {/* Data Entry */}
          {activeTab === 'data-entry' && (
            <section className="space-y-6">
              <div className={`${darkMode ? 'bg-yellow-900' : 'bg-yellow-50'} p-4 rounded border`}>Note: Data saved automatically to Local Storage. Use Export to download CSV.</div>

              {/* Department Entry */}
              <div className={`${darkMode ? 'bg-gray-800' : 'bg-white'} p-6 rounded shadow`}>
                <h3 className="font-semibold mb-4">Add Department</h3>
                <div className="space-y-3">
                  <div>
                    <input type="text" placeholder="Department Name *" value={newDept.name} onChange={(e)=>setNewDept({...newDept,name:e.target.value})}
                      className={`w-full px-4 py-2 border rounded ${errors.dept.name ? 'border-red-500' : ''} ${darkMode ? 'bg-gray-700 border-gray-600' : ''}`}/>
                    {errors.dept.name && <p className="text-red-500 text-sm mt-1">{errors.dept.name}</p>}
                  </div>
                  <div>
                    <textarea rows="3" placeholder="Current Issues *" value={newDept.issues} onChange={(e)=>setNewDept({...newDept,issues:e.target.value})}
                      className={`w-full px-4 py-2 border rounded ${errors.dept.issues ? 'border-red-500' : ''} ${darkMode ? 'bg-gray-700 border-gray-600' : ''}`}></textarea>
                    {errors.dept.issues && <p className="text-red-500 text-sm mt-1">{errors.dept.issues}</p>}
                  </div>
                  <textarea rows="2" placeholder="Barriers" value={newDept.barriers} onChange={(e)=>setNewDept({...newDept,barriers:e.target.value})}
                    className={`w-full px-4 py-2 border rounded ${darkMode ? 'bg-gray-700 border-gray-600' : ''}`}></textarea>
                  <textarea rows="2" placeholder="Recommendations" value={newDept.recommendations} onChange={(e)=>setNewDept({...newDept,recommendations:e.target.value})}
                    className={`w-full px-4 py-2 border rounded ${darkMode ? 'bg-gray-700 border-gray-600' : ''}`}></textarea>
                  <select value={newDept.priority} onChange={(e)=>setNewDept({...newDept,priority:e.target.value})}
                    className={`w-full px-4 py-2 border rounded ${darkMode ? 'bg-gray-700 border-gray-600' : ''}`}>
                    <option value="Low">Low Priority</option>
                    <option value="Medium">Medium Priority</option>
                    <option value="High">High Priority</option>
                  </select>
                  <div className="flex gap-3">
                    <button onClick={addDepartment} className="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600">Save Department</button>
                    <button onClick={resetDeptForm} className={`px-4 py-2 rounded ${darkMode ? 'bg-gray-700 hover:bg-gray-600' : 'bg-gray-200 hover:bg-gray-300'}`}>Clear Form</button>
                  </div>
                </div>

                <div className="mt-6">
                  <h4 className="font-semibold">Current Departments ({departments.length})</h4>
                  <div className="space-y-2 mt-2">
                    {departments.map((d,i)=>(
                      <div key={i} className={`p-3 rounded ${darkMode ? 'bg-gray-700' : 'bg-gray-50'} flex justify-between items-center`}>
                        <div className="flex-1">
                          <span className="font-medium">{d.name}</span>
                          <span className={`ml-2 text-xs px-2 py-1 rounded ${d.priority === 'High' ? 'bg-red-100 text-red-700' : d.priority === 'Medium' ? 'bg-yellow-100 text-yellow-700' : 'bg-green-100 text-green-700'}`}>{d.priority}</span>
                        </div>
                        <div className="flex gap-2">
                          <button onClick={() => openEditModal('department', i, d)} className="text-blue-500 hover:underline">Edit</button>
                          <button onClick={()=>removeDepartment(i)} className="text-red-500 hover:underline">Remove</button>
                        </div>
                      </div>
                    ))}
                  </div>
                </div>
              </div>

              {/* Fleet Entry */}
              <div className={`${darkMode ? 'bg-gray-800' : 'bg-white'} p-6 rounded shadow`}>
                <h3 className="font-semibold mb-4">Add Fleet Vehicle</h3>
                <div className="space-y-3">
                  <div>
                    <input type="text" placeholder="Ambulance License Number *" value={newFleet.ambulance} onChange={(e)=>setNewFleet({...newFleet,ambulance:e.target.value})}
                      className={`w-full px-4 py-2 border rounded ${errors.fleet.ambulance ? 'border-red-500' : ''} ${darkMode ? 'bg-gray-700 border-gray-600' : ''}`}/>
                    {errors.fleet.ambulance && <p className="text-red-500 text-sm mt-1">{errors.fleet.ambulance}</p>}
                  </div>
                  <div className="grid grid-cols-1 md:grid-cols-3 gap-3">
                    <div>
                      <input type="number" min="0" placeholder="Inter-facility Trips" value={newFleet.inter} onChange={(e)=>setNewFleet({...newFleet,inter:parseInt(e.target.value)||0})}
                        className={`w-full px-4 py-2 border rounded ${errors.fleet.inter ? 'border-red-500' : ''} ${darkMode ? 'bg-gray-700 border-gray-600' : ''}`}/>
                      {errors.fleet.inter && <p className="text-red-500 text-sm mt-1">{errors.fleet.inter}</p>}
                    </div>
                    <div>
                      <input type="number" min="0" placeholder="Intra-facility Trips" value={newFleet.intra} onChange={(e)=>setNewFleet({...newFleet,intra:parseInt(e.target.value)||0})}
                        className={`w-full px-4 py-2 border rounded ${errors.fleet.intra ? 'border-red-500' : ''} ${darkMode ? 'bg-gray-700 border-gray-600' : ''}`}/>
                      {errors.fleet.intra && <p className="text-red-500 text-sm mt-1">{errors.fleet.intra}</p>}
                    </div>
                    <div>
                      <input type="number" min="0" step="0.01" placeholder="Fuel Cost ($)" value={newFleet.fuel} onChange={(e)=>setNewFleet({...newFleet,fuel:parseFloat(e.target.value)||0})}
                        className={`w-full px-4 py-2 border rounded ${errors.fleet.fuel ? 'border-red-500' : ''} ${darkMode ? 'bg-gray-700 border-gray-600' : ''}`}/>
                      {errors.fleet.fuel && <p className="text-red-500 text-sm mt-1">{errors.fleet.fuel}</p>}
                    </div>
                  </div>
                  <textarea rows="2" placeholder="Remarks" value={newFleet.remarks} onChange={(e)=>setNewFleet({...newFleet,remarks:e.target.value})}
                    className={`w-full px-4 py-2 border rounded ${darkMode ? 'bg-gray-700 border-gray-600' : ''}`}></textarea>
                  <div className="flex gap-3">
                    <button onClick={addFleet} className="px-4 py-2 bg-green-500 text-white rounded hover:bg-green-600">Save Fleet Vehicle</button>
                    <button onClick={resetFleetForm} className={`px-4 py-2 rounded ${darkMode ? 'bg-gray-700 hover:bg-gray-600' : 'bg-gray-200 hover:bg-gray-300'}`}>Clear Form</button>
                  </div>
                </div>

                <div className="mt-6">
                  <h4 className="font-semibold">Current Fleet ({fleetData.length})</h4>
                  <div className="space-y-2 mt-2">
                    {fleetData.map((f,i)=>(
                      <div key={i} className={`p-3 rounded ${darkMode ? 'bg-gray-700' : 'bg-gray-50'} flex justify-between items-center`}>
                        <div className="flex-1">
                          <span className="font-medium">Ambulance {f.ambulance}</span>
                          <span className="ml-2 text-sm text-gray-500">{(parseInt(f.inter)||0)+(parseInt(f.intra)||0)} trips | ${(parseFloat(f.fuel)||0).toLocaleString()}</span>
                        </div>
                        <div className="flex gap-2">
                          <button onClick={() => openEditModal('fleet', i, f)} className="text-blue-500 hover:underline">Edit</button>
                          <button onClick={()=>removeFleet(i)} className="text-red-500 hover:underline">Remove</button>
                        </div>
                      </div>
                    ))}
                  </div>
                </div>
              </div>

              {/* Personnel Entry */}
              <div className={`${darkMode ? 'bg-gray-800' : 'bg-white'} p-6 rounded shadow`}>
                <h3 className="font-semibold mb-4">Add Personnel Update</h3>
                <div className="space-y-3">
                  <div>
                    <input type="text" placeholder="Update Title *" value={newPersonnel.title} onChange={(e)=>setNewPersonnel({...newPersonnel,title:e.target.value})}
                      className={`w-full px-4 py-2 border rounded ${errors.personnel.title ? 'border-red-500' : ''} ${darkMode ? 'bg-gray-700 border-gray-600' : ''}`}/>
                    {errors.personnel.title && <p className="text-red-500 text-sm mt-1">{errors.personnel.title}</p>}
                  </div>
                  <div>
                    <textarea rows="4" placeholder="Description *" value={newPersonnel.description} onChange={(e)=>setNewPersonnel({...newPersonnel,description:e.target.value})}
                      className={`w-full px-4 py-2 border rounded ${errors.personnel.description ? 'border-red-500' : ''} ${darkMode ? 'bg-gray-700 border-gray-600' : ''}`}></textarea>
                    {errors.personnel.description && <p className="text-red-500 text-sm mt-1">{errors.personnel.description}</p>}
                  </div>
                  <div className="flex gap-3">
                    <button onClick={addPersonnel} className="px-4 py-2 bg-purple-500 text-white rounded hover:bg-purple-600">Save Personnel Update</button>
                    <button onClick={resetPersonnelForm} className={`px-4 py-2 rounded ${darkMode ? 'bg-gray-700 hover:bg-gray-600' : 'bg-gray-200 hover:bg-gray-300'}`}>Clear Form</button>
                  </div>
                </div>

                <div className="mt-6">
                  <h4 className="font-semibold">Current Updates ({personnelUpdates.length})</h4>
                  <div className="space-y-2 mt-2">
                    {personnelUpdates.map((p,i)=>(
                      <div key={i} className={`p-3 rounded ${darkMode ? 'bg-gray-700' : 'bg-gray-50'} flex justify-between items-center`}>
                        <span className="font-medium">{p.title}</span>
                        <div className="flex gap-2">
                          <button onClick={() => openEditModal('personnel', i, p)} className="text-blue-500 hover:underline">Edit</button>
                          <button onClick={()=>removePersonnel(i)} className="text-red-500 hover:underline">Remove</button>
                        </div>
                      </div>
                    ))}
                  </div>
                </div>
              </div>

              {/* Total Patients */}
              <div className={`${darkMode ? 'bg-gray-800' : 'bg-white'} p-6 rounded shadow`}>
                <h3 className="font-semibold mb-4">Update Total Patients Transported</h3>
                <div className="flex gap-3">
                  <input type="number" min="0" value={totalPatients} onChange={(e)=>setTotalPatients(parseInt(e.target.value)||0)}
                    className={`px-4 py-2 border rounded flex-1 ${darkMode ? 'bg-gray-700 border-gray-600' : ''}`}/>
                  <button onClick={()=>showToast('Patient count updated successfully!', 'success')} className="px-4 py-2 bg-indigo-500 text-white rounded hover:bg-indigo-600">Update</button>
                </div>
                <p className="text-sm text-gray-500 mt-2">Changes are saved automatically to local storage.</p>
              </div>

              {/* Data Management Actions */}
              <div className={`${darkMode ? 'bg-gray-800' : 'bg-white'} p-6 rounded shadow`}>
                <h3 className="font-semibold mb-4">Data Management</h3>
                <div className="flex flex-wrap gap-3">
                  <button onClick={exportToCSV} className="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600">Export All Data to CSV</button>
                  <button onClick={loadFromGoogleSheet} className={`px-4 py-2 rounded ${darkMode ? 'bg-gray-700 hover:bg-gray-600' : 'bg-gray-200 hover:bg-gray-300'}`}>
                    {loading ? 'Refreshing...' : 'Refresh from Google Sheet'}
                  </button>
                  <button onClick={() => {
                    if (confirm('Are you sure you want to clear all local data? This cannot be undone.')) {
                      localStorage.removeItem(LS_KEY);
                      setDepartments(DEFAULT_DEPARTMENTS);
                      setFleetData(DEFAULT_FLEET);
                      setPersonnelUpdates(DEFAULT_PERSONNEL);
                      setTotalPatients(116);
                      showToast('Local data cleared. Defaults restored.', 'info');
                    }
                  }} className="px-4 py-2 bg-red-500 text-white rounded hover:bg-red-600">Reset to Defaults</button>
                </div>
                <p className="text-sm text-gray-500 mt-3">
                  {lastSync ? `Last synchronized: ${lastSync.toLocaleString()}` : 'Not yet synchronized with Google Sheet'}
                </p>
              </div>
            </section>
          )}
        </main>
      </div>
    );
  }

  ReactDOM.createRoot(document.getElementById('root')).render(<App />);

  </script>
</body>
</html>
