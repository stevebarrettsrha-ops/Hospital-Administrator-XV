<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Hospital Administrator Dashboard — Standalone</title>

  <!-- Tailwind (Play CDN) -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- React + ReactDOM (UMD) -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>

  <!-- Babel for in-browser JSX transpile -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

  <style>
    /* small custom adjustments */
    .tab-btn { transition: all .12s ease; }
    .card-border-left { border-left-width: 4px; }
    .chart-container { width:100%; height:260px; }
  </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 font-sans">

  <div id="root"></div>

  <script type="text/babel">
  const { useState, useEffect, useRef } = React;

  /***** Configuration *****/
  const SHEET_URL = 'https://docs.google.com/spreadsheets/d/1HTmxT2hM1XXChwPjIT2aGl93nnmcpvaMxLddzm4OouY/export?format=csv';
  const LS_KEY = 'hospital_dashboard_v1'; // localStorage key

  /***** Helper: CSV export *****/
  function downloadCSV(filename, content) {
    const blob = new Blob([content], { type: 'text/csv' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  }

  /***** Default dataset (fallback if sheet fails) *****/
  const DEFAULT_DEPARTMENTS = [
    { name: "General Storage (Food/Sundries/Sanitation)", issues: "Decentralization of storage and limited storage space impacting efficiency. Breezeway leaks and floods storage area when it rains. Donation received from National Healthcare Enhancement Fund.", barriers: "Insufficient storage space, Chill Room Out of Commission", recommendations: "Overhead expansion. Repair or replace to maximize efficiency.", priority: "High" },
    { name: "Medical Sundries Storage", issues: "Medical Sundries room flooded each time tanks overflow or during heavy rain. Eyewash station needed for Chemical Room staff.", barriers: "Delay in paying suppliers", recommendations: "Relocate water tanks. Assess structure and correct defect to prevent flooding. Down payment made for eyewash station.", priority: "High" },
    { name: "Laundry Equipment/Seamstress", issues: "New Industrial Washer still out of commission. Heat nuisance in Folding Room due to malfunctioning AC.", barriers: "Delay in procuring part (circuit board) for AC Unit", recommendations: "Replace Unit or change out parts to maximize efficiency", priority: "Medium" },
    { name: "Target Pest Management", issues: "Contractor conducting pest treatment as scheduled. Final date in October 2025.", barriers: "None", recommendations: "Continue monitoring", priority: "Low" },
    { name: "Cleaning and Portering (MEL)", issues: "Deep cleaning not done as per schedule.", barriers: "Weakness in Supervision", recommendations: "Improve supervision protocols", priority: "Medium" },
    { name: "Security (Modern Investigations)", issues: "Inconsistency in supervision", barriers: "Communication", recommendations: "Improve service delivery through ongoing training and development of Security Officers", priority: "Medium" },
    { name: "Sanitation (Rentokil Limited)", issues: "Company is responsive and issues resolved in timely manner.", barriers: "None", recommendations: "Continue current service", priority: "Low" },
    { name: "Waste Disposal (SPM Waste Management)", issues: "Occasional delay in garbage pickup", barriers: "None", recommendations: "Contact SPM when there is a challenge", priority: "Low" }
  ];

  const DEFAULT_FLEET = [
    { ambulance: "304586", inter: 10, intra: 5, fuel: 96203.8, remarks: "" },
    { ambulance: "304992", inter: 19, intra: 16, fuel: 118114.59, remarks: "Awaiting new stretcher from Regional Fleet Manager" },
    { ambulance: "305126", inter: 8, intra: 8, fuel: 9720.5, remarks: "Loaned to Chapelton Hospital Sept 23-30, 2025" }
  ];

  const DEFAULT_PERSONNEL = [
    { title: "Driver Replacement", description: "Mr. Leaughn Williams joined the Transport Team on September 23, 2025 as ambulance driver. This was a well-needed replacement and drivers are now relieved." },
    { title: "Commendation", description: "Special commendation to the transport Team for their dedication and resilience throughout the challenging period." },
    { title: "Training - Mandatory Defensive Driving Workshop", description: "Mr. Griffiths, Mr. Williams and Mr. Douglas: October 1-2, 2025, 8:30am-5pm. Mr. Chambers, Mr. Lewis and Mr. Campbell: October 8-9, 2025." }
  ];

  /***** Utility: CSV parser (simple, handles quotes) *****/
  function parseCSV(text) {
    const lines = text.split(/\r?\n/);
    const rows = lines.map(line => {
      const result = [];
      let cur = '';
      let inQuotes = false;
      for (let i = 0; i < line.length; i++) {
        const ch = line[i];
        if (ch === '"') {
          if (inQuotes && line[i+1] === '"') { cur += '"'; i++; } else { inQuotes = !inQuotes; }
        } else if (ch === ',' && !inQuotes) {
          result.push(cur);
          cur = '';
        } else {
          cur += ch;
        }
      }
      result.push(cur);
      return result;
    });
    return rows;
  }

  /***** Main App *****/
  function App(){
    // UI state
    const [activeTab, setActiveTab] = useState('overview');
    const [searchTerm, setSearchTerm] = useState('');
    const [darkMode, setDarkMode] = useState(false);
    const [notifications, setNotifications] = useState(3);
    const [username] = useState('Administrator');
    const [loading, setLoading] = useState(false);
    const [lastSync, setLastSync] = useState(null);

    // Data states
    const [departments, setDepartments] = useState([]);
    const [fleetData, setFleetData] = useState([]);
    const [personnelUpdates, setPersonnelUpdates] = useState([]);
    const [totalPatients, setTotalPatients] = useState(0);

    // Form states
    const [newDept, setNewDept] = useState({ name: '', issues: '', barriers: '', recommendations: '', priority: 'Medium' });
    const [newFleet, setNewFleet] = useState({ ambulance: '', inter: 0, intra: 0, fuel: 0, remarks: '' });
    const [newPersonnel, setNewPersonnel] = useState({ title: '', description: '' });

    // Charts refs
    const priorityChartRef = useRef(null);
    const tripsChartRef = useRef(null);
    const fleetCompareRef = useRef(null);

    // Load from localStorage if available
    useEffect(() => {
      try {
        const raw = localStorage.getItem(LS_KEY);
        if (raw) {
          const parsed = JSON.parse(raw);
          if (parsed.departments) setDepartments(parsed.departments);
          if (parsed.fleetData) setFleetData(parsed.fleetData);
          if (parsed.personnelUpdates) setPersonnelUpdates(parsed.personnelUpdates);
          if (typeof parsed.totalPatients === 'number') setTotalPatients(parsed.totalPatients);
          if (typeof parsed.darkMode === 'boolean') setDarkMode(parsed.darkMode);
          if (typeof parsed.notifications === 'number') setNotifications(parsed.notifications);
        } else {
          // initialize with defaults until sheet load
          setDepartments(DEFAULT_DEPARTMENTS);
          setFleetData(DEFAULT_FLEET);
          setPersonnelUpdates(DEFAULT_PERSONNEL);
          setTotalPatients(116);
        }
      } catch (e) {
        console.warn('Failed to load from localStorage', e);
      }
    }, []);

    // Auto-save to localStorage whenever the core data changes
    useEffect(() => {
      const payload = {
        departments,
        fleetData,
        personnelUpdates,
        totalPatients,
        darkMode,
        notifications
      };
      try {
        localStorage.setItem(LS_KEY, JSON.stringify(payload));
      } catch (e) {
        console.warn('Autosave failed', e);
      }
    }, [departments, fleetData, personnelUpdates, totalPatients, darkMode, notifications]);

    // Google Sheet loader (tries to fetch CSV, then merges with local data if present)
    const loadFromGoogleSheet = async () => {
      setLoading(true);
      try {
        const res = await fetch(SHEET_URL);
        if (!res.ok) throw new Error('Network response not ok');
        const csv = await res.text();
        const rows = parseCSV(csv);

        // We'll extract roughly the same rows as original TSX expected
        const depts = [];
        // rows indexing may vary; attempt safe extraction with fallback
        // We'll attempt to find rows that look like department rows by content length
        // but to keep faithful, use previously-known indices (1,3,5,7,9,11,12,13) if present
        const idxs = [1,3,5,7,9,11,12,13];
        idxs.forEach(i => {
          if (rows[i]) {
            // try to map columns to fields
            const row = rows[i];
            const name = row[0] || '';
            const issues = row[1] || '';
            const barriers = row[2] || '';
            const recommendations = row[3] || '';
            // Choose priority based on presence of certain words (fallback to Medium)
            let priority = 'Medium';
            if (/flood|out of commission|delay|insufficient|urgent|critical/i.test(issues + barriers + recommendations)) priority = 'High';
            if (/none|continue/i.test(barriers + recommendations)) priority = 'Low';
            depts.push({ name: name || DEFAULT_DEPARTMENTS[0].name, issues, barriers, recommendations, priority });
          }
        });

        // If no depts parsed, fallback to defaults
        const finalDepts = depts.length ? depts : DEFAULT_DEPARTMENTS;

        // fleet rows indices 17-19
        const fleet = [];
        for (let i = 17; i <= 19; i++) {
          if (rows[i] && rows[i][0]) {
            const ambulance = rows[i][0] || '';
            const inter = parseInt(rows[i][1]) || 0;
            const intra = parseInt(rows[i][2]) || 0;
            const fuel = parseFloat((rows[i][3] || '0').replace(/[^0-9.-]+/g,'')) || 0;
            const remarks = rows[i][4] || '';
            fleet.push({ ambulance, inter, intra, fuel, remarks });
          }
        }
        const finalFleet = fleet.length ? fleet : DEFAULT_FLEET;

        // total patients row 23 (index 23)
        let sheetTotalPatients = null;
        if (rows[23] && rows[23][0]) {
          sheetTotalPatients = parseInt(rows[23][0]) || null;
        }

        // personnel (rows 25-33 area)
        const personnel = [];
        if (rows[25] && rows[25][0]) {
          personnel.push({ title: 'Driver Replacement', description: (rows[25][0] + ' ' + (rows[26] ? rows[26][0] : '')).trim() });
        }
        if (rows[28] && rows[28][0]) {
          personnel.push({ title: 'Commendation', description: rows[28][0] });
        }
        if (rows[30] && rows[30][0]) {
          const trainingDesc = [rows[30][0], rows[31]?.[0], rows[32]?.[0]].filter(Boolean).join(' ');
          personnel.push({ title: 'Training - Mandatory Defensive Driving Workshop', description: trainingDesc });
        }
        const finalPersonnel = personnel.length ? personnel : DEFAULT_PERSONNEL;

        // Merge strategy: prefer local values if present (so local edits persist)
        const rawLocal = localStorage.getItem(LS_KEY);
        if (rawLocal) {
          try {
            const parsed = JSON.parse(rawLocal);
            // If local has arrays with length > 0, use them; otherwise use sheet
            setDepartments((parsed.departments && parsed.departments.length) ? parsed.departments : finalDepts);
            setFleetData((parsed.fleetData && parsed.fleetData.length) ? parsed.fleetData : finalFleet);
            setPersonnelUpdates((parsed.personnelUpdates && parsed.personnelUpdates.length) ? parsed.personnelUpdates : finalPersonnel);
            setTotalPatients((typeof parsed.totalPatients === 'number' && parsed.totalPatients >= 0) ? parsed.totalPatients : (sheetTotalPatients ?? 116));
          } catch (e) {
            // parse failure -> use sheet results
            setDepartments(finalDepts);
            setFleetData(finalFleet);
            setPersonnelUpdates(finalPersonnel);
            setTotalPatients(sheetTotalPatients ?? 116);
          }
        } else {
          // No local -> use sheet results
          setDepartments(finalDepts);
          setFleetData(finalFleet);
          setPersonnelUpdates(finalPersonnel);
          setTotalPatients(sheetTotalPatients ?? 116);
        }

        setLastSync(new Date());
        alert('Data loaded from Google Sheet and merged with local data (local takes precedence).');
      } catch (err) {
        console.warn('Sheet load failed, using local/defaults', err);
        alert('Could not load data from Google Sheet — using local or default data.');
      } finally {
        setLoading(false);
      }
    };

    // initial attempt to fetch sheet once after mount (but we already loaded local)
    useEffect(() => {
      loadFromGoogleSheet();
    }, []);

    /***** Derived metrics *****/
    const totalTrips = fleetData.reduce((s,i) => s + (parseInt(i.inter)||0) + (parseInt(i.intra)||0), 0);
    const totalFuel = fleetData.reduce((s,i) => s + (parseFloat(i.fuel)||0), 0);

    /***** Charts setup & updates (Chart.js) *****/
    // Priority pie
    useEffect(() => {
      const counts = {
        High: departments.filter(d => d.priority === 'High').length,
        Medium: departments.filter(d => d.priority === 'Medium').length,
        Low: departments.filter(d => d.priority === 'Low').length
      };
      const ctx = priorityChartRef.current;
      if (!ctx) return;
      if (ctx._chartInstance) { ctx._chartInstance.destroy(); ctx._chartInstance = null; }
      ctx._chartInstance = new Chart(ctx, {
        type: 'pie',
        data: {
          labels: ['High Priority','Medium Priority','Low Priority'],
          datasets: [{ data: [counts.High, counts.Medium, counts.Low], backgroundColor: ['#ef4444','#f59e0b','#10b981'] }]
        },
        options: { responsive: true, plugins: { legend: { position: 'bottom' } } }
      });
    }, [departments]);

    // Trips bar (small)
    useEffect(() => {
      const ctx = tripsChartRef.current;
      if (!ctx) return;
      if (ctx._chartInstance) { ctx._chartInstance.destroy(); ctx._chartInstance = null; }
      ctx._chartInstance = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: fleetData.map(f => f.ambulance),
          datasets: [
            { label: 'Inter-facility', data: fleetData.map(f => f.inter), backgroundColor: '#3b82f6' },
            { label: 'Intra-facility', data: fleetData.map(f => f.intra), backgroundColor: '#8b5cf6' }
          ]
        },
        options: { responsive: true, plugins: { legend: { position: 'bottom' } }, scales: { y: { beginAtZero: true } } }
      });
    }, [fleetData]);

    // Fleet compare (large)
    useEffect(() => {
      const ctx = fleetCompareRef.current;
      if (!ctx) return;
      if (ctx._chartInstance) { ctx._chartInstance.destroy(); ctx._chartInstance = null; }
      ctx._chartInstance = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: fleetData.map(f => f.ambulance),
          datasets: [
            { label: 'Inter-facility', data: fleetData.map(f => f.inter), backgroundColor: '#3b82f6' },
            { label: 'Intra-facility', data: fleetData.map(f => f.intra), backgroundColor: '#8b5cf6' }
          ]
        },
        options: { responsive: true, plugins: { legend: { position: 'bottom' } }, scales: { y: { beginAtZero: true } } }
      });
    }, [fleetData]);

    /***** CRUD operations (auto-saved because of effect hooking into state) *****/
    const addDepartment = () => {
      if (!newDept.name || !newDept.issues) { alert('Please provide department name and issues'); return; }
      setDepartments(prev => [...prev, {...newDept}]);
      setNewDept({ name:'', issues:'', barriers:'', recommendations:'', priority:'Medium' });
      setActiveTab('departments');
    };

    const removeDepartment = (idx) => {
      if (!confirm('Remove this department?')) return;
      setDepartments(prev => prev.filter((_,i)=>i!==idx));
    };

    const addFleet = () => {
      if (!newFleet.ambulance) { alert('Enter ambulance license'); return; }
      setFleetData(prev => [...prev, {...newFleet, inter: parseInt(newFleet.inter)||0, intra: parseInt(newFleet.intra)||0, fuel: parseFloat(newFleet.fuel)||0 }]);
      setNewFleet({ ambulance:'', inter:0, intra:0, fuel:0, remarks:'' });
      setActiveTab('fleet');
    };

    const removeFleet = (idx) => {
      if (!confirm('Remove this vehicle?')) return;
      setFleetData(prev => prev.filter((_,i)=>i!==idx));
    };

    const addPersonnel = () => {
      if (!newPersonnel.title || !newPersonnel.description) { alert('Fill title and description'); return; }
      setPersonnelUpdates(prev => [...prev, {...newPersonnel}]);
      setNewPersonnel({ title:'', description:'' });
      setActiveTab('personnel');
    };

    const removePersonnel = (idx) => {
      if (!confirm('Remove this personnel update?')) return;
      setPersonnelUpdates(prev => prev.filter((_,i)=>i!==idx));
    };

    const exportToCSV = () => {
      let csv = 'DEPARTMENT,ISSUES,BARRIERS,RECOMMENDATIONS,PRIORITY\n';
      departments.forEach(d => {
        csv += `"${(d.name||'').replace(/"/g,'""')}","${(d.issues||'').replace(/"/g,'""')}","${(d.barriers||'').replace(/"/g,'""')}","${(d.recommendations||'').replace(/"/g,'""')}","${d.priority}"\n`;
      });
      csv += '\nFLEET\nAMBULANCE,INTER,INTRA,FUEL,REMARKS\n';
      fleetData.forEach(f => {
        csv += `"${(f.ambulance||'').replace(/"/g,'""')}",${f.inter||0},${f.intra||0},${f.fuel||0},"${(f.remarks||'').replace(/"/g,'""')}"\n`;
      });
      csv += `\nTOTAL_PATIENTS,${totalPatients}\n\nPERSONNEL\nTITLE,DESCRIPTION\n`;
      personnelUpdates.forEach(p => {
        csv += `"${(p.title||'').replace(/"/g,'""')}","${(p.description||'').replace(/"/g,'""')}"\n`;
      });
      downloadCSV('hospital_report.csv', csv);
    };

    const handleLogout = () => {
      alert('Logging out...');
    };

    /***** UI render *****/
    return (
      <div className={darkMode ? 'min-h-screen bg-gray-900 text-white' : 'min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 text-gray-900'}>
        {/* Top bar */}
        <div className={darkMode ? 'bg-gray-800 border-b border-gray-700' : 'bg-white border-b border-gray-200'}>
          <div className="container mx-auto px-4 py-3 flex items-center justify-between">
            <div className="flex items-center space-x-3">
              <div className={`w-10 h-10 rounded-full ${darkMode ? 'bg-blue-600' : 'bg-blue-500'} flex items-center justify-center text-white font-bold`}>
                {username.charAt(0)}
              </div>
              <div>
                <p className="font-semibold">{username}</p>
                <p className="text-xs">{'Hospital Administrator'}</p>
              </div>
            </div>

            <div className="flex items-center space-x-3">
              {lastSync && <div className="text-xs hidden md:block">Last sync: {lastSync.toLocaleString()}</div>}
              <button onClick={loadFromGoogleSheet} className={`px-3 py-2 rounded ${darkMode ? 'bg-gray-700 hover:bg-gray-600' : 'bg-gray-100 hover:bg-gray-200'}`}>{loading ? 'Refreshing...' : 'Refresh'}</button>
              <button onClick={exportToCSV} className={`px-3 py-2 rounded ${darkMode ? 'bg-gray-700 hover:bg-gray-600' : 'bg-gray-100 hover:bg-gray-200'}`}>Export</button>
              <button onClick={() => setDarkMode(!darkMode)} className={`px-3 py-2 rounded ${darkMode ? 'bg-gray-700 hover:bg-gray-600' : 'bg-gray-100 hover:bg-gray-200'}`}>{darkMode ? 'Light' : 'Dark'}</button>
              <div className="relative">
                <button className={`px-3 py-2 rounded ${darkMode ? 'bg-gray-700 hover:bg-gray-600' : 'bg-gray-100 hover:bg-gray-200'}`}>Bell</button>
                {notifications > 0 && <span className="absolute -top-1 -right-1 bg-red-500 text-white text-xs rounded-full w-5 h-5 flex items-center justify-center">{notifications}</span>}
              </div>
              <button onClick={handleLogout} className="px-3 py-2 bg-red-500 text-white rounded">Logout</button>
            </div>
          </div>
        </div>

        {/* Header */}
        <div className={darkMode ? 'bg-gradient-to-r from-gray-800 to-gray-900 text-white' : 'bg-gradient-to-r from-blue-600 to-indigo-700 text-white'}>
          <div className="container mx-auto px-4 py-6">
            <h1 className="text-3xl font-bold">Hospital Administrator Dashboard</h1>
            <p className="text-sm">{lastSync ? `September 2025 Report - Last sync ${lastSync.toLocaleString()}` : 'September 2025 Report'}</p>
          </div>
        </div>

        {/* Tabs */}
        <div className={darkMode ? 'bg-gray-800' : 'bg-white'}>
          <div className="container mx-auto px-4">
            <div className="flex space-x-1 overflow-x-auto">
              {[
                { id: 'overview', label: 'Overview' },
                { id: 'departments', label: 'Departments' },
                { id: 'fleet', label: 'Fleet Report' },
                { id: 'personnel', label: 'Personnel' },
                { id: 'data-entry', label: 'Data Entry' }
              ].map(tab => (
                <button key={tab.id} onClick={() => setActiveTab(tab.id)}
                  className={`py-4 px-6 ${activeTab===tab.id ? 'border-b-4 border-blue-600 text-blue-600' : 'text-gray-600 hover:bg-gray-50'} whitespace-nowrap`}>
                  {tab.label}
                </button>
              ))}
            </div>
          </div>
        </div>

        {/* Main content */}
        <main className="container mx-auto px-4 py-8 space-y-6">
          {/* Loading overlay */}
          {loading && (
            <div className="fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center z-50">
              <div className="bg-white p-6 rounded shadow">Loading data...</div>
            </div>
          )}

          {/* Overview */}
          {activeTab === 'overview' && (
            <section className="space-y-6">
              <div className={darkMode ? 'bg-gray-800 p-4 rounded border border-gray-700' : 'bg-blue-50 p-4 rounded border border-blue-200'}>
                <div className="flex items-center justify-between">
                  <div>
                    <div className="font-semibold">{ lastSync ? 'Connected to Google Sheets' : 'Attempting to connect to Google Sheets' }</div>
                    <div className="text-sm">{ lastSync ? `Last updated: ${lastSync.toLocaleString()}` : 'Loading...' }</div>
                  </div>
                  <div>
                    <button onClick={loadFromGoogleSheet} className="px-3 py-2 bg-blue-500 text-white rounded">Refresh</button>
                  </div>
                </div>
              </div>

              {/* Key metrics */}
              <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                <div className={`rounded-lg shadow-md p-6 border-l-4 border-blue-500 ${darkMode ? 'bg-gray-800' : 'bg-white'}`}>
                  <p className="text-sm text-gray-500">Total Departments</p>
                  <p className="text-3xl font-bold mt-2">{departments.length}</p>
                </div>
                <div className={`rounded-lg shadow-md p-6 border-l-4 border-green-500 ${darkMode ? 'bg-gray-800' : 'bg-white'}`}>
                  <p className="text-sm text-gray-500">Total Ambulance Trips</p>
                  <p className="text-3xl font-bold mt-2">{totalTrips}</p>
                </div>
                <div className={`rounded-lg shadow-md p-6 border-l-4 border-purple-500 ${darkMode ? 'bg-gray-800' : 'bg-white'}`}>
                  <p className="text-sm text-gray-500">Patients Transported</p>
                  <p className="text-3xl font-bold mt-2">{totalPatients}</p>
                </div>
                <div className={`rounded-lg shadow-md p-6 border-l-4 border-red-500 ${darkMode ? 'bg-gray-800' : 'bg-white'}`}>
                  <p className="text-sm text-gray-500">High Priority Issues</p>
                  <p className="text-3xl font-bold mt-2">{departments.filter(d=>d.priority==='High').length}</p>
                </div>
              </div>

              {/* Charts */}
              <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div className={`${darkMode ? 'bg-gray-800' : 'bg-white'} p-6 rounded shadow`}>
                  <h3 className="font-semibold mb-4">Issues by Priority</h3>
                  <div className="chart-container">
                    <canvas ref={priorityChartRef}></canvas>
                  </div>
                </div>

                <div className={`${darkMode ? 'bg-gray-800' : 'bg-white'} p-6 rounded shadow`}>
                  <h3 className="font-semibold mb-4">Ambulance Trip Distribution</h3>
                  <div className="chart-container">
                    <canvas ref={tripsChartRef}></canvas>
                  </div>
                </div>
              </div>

              {/* Executive summary */}
              <div className={`${darkMode ? 'bg-gray-800' : 'bg-white'} p-6 rounded shadow`}>
                <h3 className="font-semibold mb-4">Executive Summary</h3>
                <div className="grid md:grid-cols-2 gap-4">
                  <div className="border-l-4 border-red-500 pl-4 py-2">
                    <h4 className="font-semibold text-red-700 mb-2">Critical Issues</h4>
                    <ul className="text-sm space-y-1">
                      {departments.filter(d=>d.priority==='High').slice(0,3).map((d,i)=>(<li key={i}>• {d.name}</li>))}
                    </ul>
                  </div>
                  <div className="border-l-4 border-green-500 pl-4 py-2">
                    <h4 className="font-semibold text-green-700 mb-2">Positive Updates</h4>
                    <ul className="text-sm space-y-1">
                      <li>• {totalPatients} patients transported successfully</li>
                      <li>• {fleetData.length} ambulances in active service</li>
                      <li>• {departments.filter(d=>d.priority==='Low').length} departments performing well</li>
                    </ul>
                  </div>
                </div>
              </div>
            </section>
          )}

          {/* Departments */}
          {activeTab === 'departments' && (
            <section className="space-y-6">
              <div className={`${darkMode ? 'bg-gray-800' : 'bg-white'} p-4 rounded shadow`}>
                <div className="relative">
                  <input value={searchTerm} onChange={(e)=>setSearchTerm(e.target.value)} placeholder="Search departments, issues, or barriers..." className="w-full pl-4 pr-4 py-2 border rounded" />
                </div>
              </div>

              <div className="grid gap-6">
                {departments.filter(d => d.name.toLowerCase().includes(searchTerm.toLowerCase()) || d.issues.toLowerCase().includes(searchTerm.toLowerCase()))
                  .map((dept, idx) => (
                  <div key={idx} className={`${darkMode ? 'bg-gray-800' : 'bg-white'} rounded shadow overflow-hidden`}>
                    <div className={`p-4 ${dept.priority==='High' ? 'border-l-4 border-red-500 bg-red-50' : dept.priority==='Medium' ? 'border-l-4 border-yellow-500 bg-yellow-50' : 'border-l-4 border-green-500 bg-green-50'}`}>
                      <div className="flex justify-between">
                        <h3 className="font-semibold">{dept.name}</h3>
                        <span className="px-3 py-1 rounded-full text-xs font-semibold">
                          {dept.priority} Priority
                        </span>
                      </div>
                    </div>
                    <div className="p-6 space-y-3">
                      <div>
                        <h4 className="font-semibold">Current Issues</h4>
                        <p className="text-sm">{dept.issues}</p>
                      </div>
                      {dept.barriers && dept.barriers !== 'None' && (
                        <div>
                          <h4 className="font-semibold">Barriers</h4>
                          <p className="text-sm">{dept.barriers}</p>
                        </div>
                      )}
                      <div>
                        <h4 className="font-semibold">Recommendations</h4>
                        <p className="text-sm">{dept.recommendations}</p>
                      </div>
                      <div className="flex justify-end">
                        <button onClick={()=>removeDepartment(idx)} className="px-3 py-2 text-red-500">Remove</button>
                      </div>
                    </div>
                  </div>
                ))}
              </div>
            </section>
          )}

          {/* Fleet */}
          {activeTab === 'fleet' && (
            <section className="space-y-6">
              <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div className={`${darkMode ? 'bg-gray-800' : 'bg-white'} p-6 rounded shadow`}>
                  <h4 className="text-sm">Total Trips</h4>
                  <p className="text-3xl font-bold text-blue-600">{totalTrips}</p>
                  <p className="text-xs mt-1">Inter: {fleetData.reduce((s,i)=>s+(parseInt(i.inter)||0),0)} | Intra: {fleetData.reduce((s,i)=>s+(parseInt(i.intra)||0),0)}</p>
                </div>
                <div className={`${darkMode ? 'bg-gray-800' : 'bg-white'} p-6 rounded shadow`}>
                  <h4 className="text-sm">Patients Transported</h4>
                  <p className="text-3xl font-bold text-green-600">{totalPatients}</p>
                </div>
                <div className={`${darkMode ? 'bg-gray-800' : 'bg-white'} p-6 rounded shadow`}>
                  <h4 className="text-sm">Total Fuel Cost</h4>
                  <p className="text-3xl font-bold text-purple-600">${totalFuel.toLocaleString(undefined,{minimumFractionDigits:2, maximumFractionDigits:2})}</p>
                </div>
              </div>

              <div className={`${darkMode ? 'bg-gray-800' : 'bg-white'} rounded shadow overflow-hidden`}>
                <div className="p-6">
                  <h3 className="font-semibold mb-4">Ambulance Fleet Details</h3>
                  <div className="overflow-x-auto">
                    <table className="min-w-full">
                      <thead className={`${darkMode ? 'bg-gray-700' : 'bg-gray-50'}`}>
                        <tr>
                          <th className="px-4 py-2 text-left text-xs">License #</th>
                          <th className="px-4 py-2 text-left text-xs">Inter-facility</th>
                          <th className="px-4 py-2 text-left text-xs">Intra-facility</th>
                          <th className="px-4 py-2 text-left text-xs">Total Trips</th>
                          <th className="px-4 py-2 text-left text-xs">Fuel Cost</th>
                          <th className="px-4 py-2 text-left text-xs">Remarks</th>
                          <th className="px-4 py-2 text-left text-xs">Action</th>
                        </tr>
                      </thead>
                      <tbody>
                        {fleetData.map((v, i) => (
                          <tr key={i} className="hover:bg-gray-50">
                            <td className="px-4 py-2">{v.ambulance}</td>
                            <td className="px-4 py-2">{v.inter}</td>
                            <td className="px-4 py-2">{v.intra}</td>
                            <td className="px-4 py-2 font-semibold">{(parseInt(v.inter)||0)+(parseInt(v.intra)||0)}</td>
                            <td className="px-4 py-2">${(parseFloat(v.fuel)||0).toLocaleString(undefined,{minimumFractionDigits:2})}</td>
                            <td className="px-4 py-2">{v.remarks||'-'}</td>
                            <td className="px-4 py-2"><button onClick={()=>removeFleet(i)} className="text-red-500">Remove</button></td>
                          </tr>
                        ))}
                        <tr className="font-semibold bg-blue-50">
                          <td className="px-4 py-2">TOTAL</td>
                          <td className="px-4 py-2">{fleetData.reduce((s,i)=>s+(parseInt(i.inter)||0),0)}</td>
                          <td className="px-4 py-2">{fleetData.reduce((s,i)=>s+(parseInt(i.intra)||0),0)}</td>
                          <td className="px-4 py-2">{totalTrips}</td>
                          <td className="px-4 py-2">${totalFuel.toLocaleString(undefined,{minimumFractionDigits:2})}</td>
                          <td className="px-4 py-2">-</td>
                          <td></td>
                        </tr>
                      </tbody>
                    </table>
                  </div>
                </div>
              </div>

              <div className={`${darkMode ? 'bg-gray-800' : 'bg-white'} p-6 rounded shadow`}>
                <h3 className="font-semibold mb-4">Trip Comparison by Ambulance</h3>
                <div className="chart-container">
                  <canvas ref={fleetCompareRef}></canvas>
                </div>
              </div>
            </section>
          )}

          {/* Personnel */}
          {activeTab === 'personnel' && (
            <section className="space-y-6">
              {personnelUpdates.map((u,i)=>(
                <div key={i} className={`${darkMode ? 'bg-gray-800' : 'bg-white'} p-6 rounded shadow`}>
                  <div className="flex items-start gap-4">
                    <div className={`${darkMode ? 'bg-blue-700' : 'bg-blue-100'} rounded-full p-3`}>U</div>
                    <div className="flex-1">
                      <h3 className="font-semibold">{u.title}</h3>
                      <p className="text-sm">{u.description}</p>
                    </div>
                    <div><button onClick={()=>removePersonnel(i)} className="text-red-500">Remove</button></div>
                  </div>
                </div>
              ))}
            </section>
          )}

          {/* Data Entry */}
          {activeTab === 'data-entry' && (
            <section className="space-y-6">
              <div className={`${darkMode ? 'bg-yellow-900' : 'bg-yellow-50'} p-4 rounded border`}>Note: Data saved automatically to Local Storage. Use Export to download CSV.</div>

              {/* Department Entry */}
              <div className={`${darkMode ? 'bg-gray-800' : 'bg-white'} p-6 rounded shadow`}>
                <h3 className="font-semibold mb-4">Add Department</h3>
                <div className="space-y-3">
                  <input type="text" placeholder="Department Name" value={newDept.name} onChange={(e)=>setNewDept({...newDept,name:e.target.value})} className="w-full px-4 py-2 border rounded"/>
                  <textarea rows="3" placeholder="Current Issues" value={newDept.issues} onChange={(e)=>setNewDept({...newDept,issues:e.target.value})} className="w-full px-4 py-2 border rounded"></textarea>
                  <textarea rows="2" placeholder="Barriers" value={newDept.barriers} onChange={(e)=>setNewDept({...newDept,barriers:e.target.value})} className="w-full px-4 py-2 border rounded"></textarea>
                  <textarea rows="2" placeholder="Recommendations" value={newDept.recommendations} onChange={(e)=>setNewDept({...newDept,recommendations:e.target.value})} className="w-full px-4 py-2 border rounded"></textarea>
                  <select value={newDept.priority} onChange={(e)=>setNewDept({...newDept,priority:e.target.value})} className="w-full px-4 py-2 border rounded">
                    <option value="Low">Low Priority</option>
                    <option value="Medium">Medium Priority</option>
                    <option value="High">High Priority</option>
                  </select>
                  <div className="flex gap-3">
                    <button onClick={addDepartment} className="px-4 py-2 bg-blue-500 text-white rounded">Save Department</button>
                  </div>
                </div>

                <div className="mt-6">
                  <h4 className="font-semibold">Current Departments ({departments.length})</h4>
                  <div className="space-y-2 mt-2">
                    {departments.map((d,i)=>(
                      <div key={i} className={`p-3 rounded ${darkMode ? 'bg-gray-700' : 'bg-gray-50'} flex justify-between items-center`}>
                        <span>{d.name}</span>
                        <button onClick={()=>removeDepartment(i)} className="text-red-500">Remove</button>
                      </div>
                    ))}
                  </div>
                </div>
              </div>

              {/* Fleet Entry */}
              <div className={`${darkMode ? 'bg-gray-800' : 'bg-white'} p-6 rounded shadow`}>
                <h3 className="font-semibold mb-4">Add Fleet Vehicle</h3>
                <div className="space-y-3">
                  <input type="text" placeholder="Ambulance License Number" value={newFleet.ambulance} onChange={(e)=>setNewFleet({...newFleet,ambulance:e.target.value})} className="w-full px-4 py-2 border rounded"/>
                  <div className="grid grid-cols-1 md:grid-cols-3 gap-3">
                    <input type="number" placeholder="Inter-facility Trips" value={newFleet.inter} onChange={(e)=>setNewFleet({...newFleet,inter:parseInt(e.target.value)||0})} className="px-4 py-2 border rounded"/>
                    <input type="number" placeholder="Intra-facility Trips" value={newFleet.intra} onChange={(e)=>setNewFleet({...newFleet,intra:parseInt(e.target.value)||0})} className="px-4 py-2 border rounded"/>
                    <input type="number" placeholder="Fuel Cost" value={newFleet.fuel} onChange={(e)=>setNewFleet({...newFleet,fuel:parseFloat(e.target.value)||0})} className="px-4 py-2 border rounded"/>
                  </div>
                  <textarea rows="2" placeholder="Remarks" value={newFleet.remarks} onChange={(e)=>setNewFleet({...newFleet,remarks:e.target.value})} className="w-full px-4 py-2 border rounded"></textarea>
                  <button onClick={addFleet} className="px-4 py-2 bg-green-500 text-white rounded">Save Fleet Vehicle</button>
                </div>

                <div className="mt-6">
                  <h4 className="font-semibold">Current Fleet ({fleetData.length})</h4>
                  <div className="space-y-2 mt-2">
                    {fleetData.map((f,i)=>(
                      <div key={i} className={`p-3 rounded ${darkMode ? 'bg-gray-700' : 'bg-gray-50'} flex justify-between items-center`}>
                        <span>Ambulance {f.ambulance} - {(parseInt(f.inter)||0)+(parseInt(f.intra)||0)} trips</span>
                        <button onClick={()=>removeFleet(i)} className="text-red-500">Remove</button>
                      </div>
                    ))}
                  </div>
                </div>
              </div>

              {/* Personnel Entry */}
              <div className={`${darkMode ? 'bg-gray-800' : 'bg-white'} p-6 rounded shadow`}>
                <h3 className="font-semibold mb-4">Add Personnel Update</h3>
                <div className="space-y-3">
                  <input type="text" placeholder="Update Title" value={newPersonnel.title} onChange={(e)=>setNewPersonnel({...newPersonnel,title:e.target.value})} className="w-full px-4 py-2 border rounded"/>
                  <textarea rows="4" placeholder="Description" value={newPersonnel.description} onChange={(e)=>setNewPersonnel({...newPersonnel,description:e.target.value})} className="w-full px-4 py-2 border rounded"></textarea>
                  <button onClick={addPersonnel} className="px-4 py-2 bg-purple-500 text-white rounded">Save Personnel Update</button>
                </div>

                <div className="mt-6">
                  <h4 className="font-semibold">Current Updates ({personnelUpdates.length})</h4>
                  <div className="space-y-2 mt-2">
                    {personnelUpdates.map((p,i)=>(
                      <div key={i} className={`p-3 rounded ${darkMode ? 'bg-gray-700' : 'bg-gray-50'} flex justify-between items-center`}>
                        <span>{p.title}</span>
                        <button onClick={()=>removePersonnel(i)} className="text-red-500">Remove</button>
                      </div>
                    ))}
                  </div>
                </div>
              </div>

              {/* Total Patients */}
              <div className={`${darkMode ? 'bg-gray-800' : 'bg-white'} p-6 rounded shadow`}>
                <h3 className="font-semibold mb-4">Update Total Patients Transported</h3>
                <div className="flex gap-3">
                  <input type="number" value={totalPatients} onChange={(e)=>setTotalPatients(parseInt(e.target.value)||0)} className="px-4 py-2 border rounded flex-1"/>
                  <button onClick={()=>alert('Patient count updated!')} className="px-4 py-2 bg-indigo-500 text-white rounded">Update</button>
                </div>
              </div>
            </section>
          )}
        </main>
      </div>
    );
  }

  ReactDOM.createRoot(document.getElementById('root')).render(<App />);

  </script>
</body>
</html>
